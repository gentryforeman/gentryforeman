<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Foreman System</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f3f4f6; color: #333; -webkit-tap-highlight-color: transparent; }
.screen { display: none; }
.screen.active { display: block; }
.login-container { max-width: 400px; margin: 100px auto; padding: 40px; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
.logo { text-align: center; margin-bottom: 30px; }
.logo h1 { font-size: 48px; margin-bottom: 10px; }
.logo h2 { color: #333; font-size: 24px; }
.input-group { margin-bottom: 20px; }
.input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 14px; }
.input-group input, .input-group select, .input-group textarea {
  width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 12px;
  font-size: 16px; background: #f9fafb; color: #333;
  -webkit-appearance: none; appearance: none;
}
.input-group input:focus, .input-group select:focus, .input-group textarea:focus {
  outline: none; border-color: #2563eb; background: white;
}
.btn { padding: 14px 24px; border: none; border-radius: 12px; font-size: 16px; cursor: pointer; font-weight: 600; transition: all 0.2s; min-height: 48px; }
.btn-primary { background: #2563eb; color: white; }
.btn-primary:hover { background: #1d4ed8; }
.btn-secondary { background: #e5e7eb; color: #333; }
.btn-success { background: #22c55e; color: white; }
.btn-success:hover { background: #16a34a; }
.btn-large { width: 100%; padding: 16px; font-size: 18px; }
.app-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
.app-header h1 { font-size: 18px; color: #333; }
.icon-btn { background: none; border: none; font-size: 24px; cursor: pointer; padding: 8px; color: #333; min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center; }
.side-menu { position: fixed; left: -280px; top: 0; width: 280px; height: 100%; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.1); transition: left 0.3s; z-index: 1001; }
.side-menu.open { left: 0; }
.menu-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #eee; }
.menu-list { list-style: none; padding: 10px 0; }
.menu-item { padding: 16px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; font-size: 16px; min-height: 52px; }
.menu-item:hover, .menu-item.active { background: #f3f4f6; }
.menu-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
.menu-overlay.open { display: block; }
.main-content { padding: 15px; padding-bottom: 100px; }
.view { display: none; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: flex-end; z-index: 1002; }
.modal-content { background: white; border-radius: 20px 20px 0 0; width: 100%; max-width: 600px; max-height: 95vh; overflow: auto; animation: slideUp 0.3s ease-out; }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
.modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid #eee; position: sticky; top: 0; background: white; z-index: 10; }
.modal-header h2 { margin: 0; font-size: 18px; }
.modal-body { padding: 20px; }
.modal-footer { display: flex; gap: 10px; padding: 16px 20px; border-top: 1px solid #eee; position: sticky; bottom: 0; background: white; }
.modal-footer .btn { flex: 1; }
.calendar-box { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.calendar-grid { display: grid; grid-template-columns: repeat(7,1fr); gap: 2px; background: #e5e7eb; border-radius: 8px; overflow: hidden; }
.calendar-header { background: #2563eb; color: white; padding: 10px; text-align: center; font-weight: bold; font-size: 12px; }
.calendar-day { background: white; padding: 8px; min-height: 80px; cursor: pointer; }
.calendar-day:hover { background: #f3f4f6; }
.calendar-day.today { background: #dbeafe; border: 2px solid #2563eb; }
.calendar-day.drag-over { background: #bfdbfe; border: 2px dashed #2563eb; }
.job-tag { font-size: 11px; padding: 3px 6px; border-radius: 4px; margin-top: 3px; color: white; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
.crew-legend { display: flex; flex-wrap: wrap; gap: 12px; padding: 15px; background: white; border-radius: 12px; margin-top: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.crew-item { display: flex; align-items: center; gap: 6px; }
.crew-color { width: 16px; height: 16px; border-radius: 4px; }
.jobs-sidebar { position: fixed; left: -320px; top: 0; width: 320px; height: 100%; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.1); transition: left 0.3s; z-index: 1001; overflow-y: auto; }
.jobs-sidebar.open { left: 0; }
.jobs-sidebar-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #eee; background: #2563eb; color: white; }
.jobs-sidebar-header h3 { margin: 0; }
.jobs-search { padding: 15px; border-bottom: 1px solid #eee; }
.jobs-search input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
.jobs-list { padding: 10px; }
.sidebar-job { padding: 12px 15px; margin: 8px 0; background: #f3f4f6; border-radius: 8px; cursor: grab; border-left: 4px solid #2563eb; }
.sidebar-job.closed { opacity: 0.6; border-left-color: #9ca3af; }
.toggle-jobs-btn { position: fixed; left: 15px; bottom: 80px; padding: 15px 25px; border-radius: 8px; background: #2563eb; color: white; border: none; font-size: 16px; cursor: pointer; box-shadow: 0 4px 12px rgba(37,99,235,0.4); z-index: 999; min-height: 52px; }

/* Today's Jobs Section */
.todays-jobs { margin-bottom: 24px; }
.todays-jobs-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.todays-jobs-header h3 { font-size: 16px; color: #64748b; font-weight: 600; }
.job-card { background: white; border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 5px solid #22c55e; }
.job-card.has-record { border-left-color: #3b82f6; opacity: 0.7; }
.job-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
.job-card-info h4 { font-size: 16px; color: #1e293b; margin-bottom: 4px; }
.job-card-info .job-number { color: #2563eb; font-weight: 700; }
.job-card-info .job-meta { font-size: 13px; color: #64748b; }
.job-card-crew { display: flex; align-items: center; gap: 6px; padding: 6px 10px; background: #f1f5f9; border-radius: 8px; font-size: 13px; }
.job-card-crew .crew-dot { width: 10px; height: 10px; border-radius: 50%; }
.job-card-actions { display: flex; gap: 8px; }
.quick-add-btn { flex: 1; padding: 14px 16px; background: #22c55e; color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; min-height: 52px; }
.quick-add-btn:hover { background: #16a34a; }
.quick-add-btn.done { background: #64748b; }

/* Photo upload styles */
.photo-upload-area { border: 2px dashed #d1d5db; border-radius: 12px; padding: 24px; text-align: center; cursor: pointer; transition: all 0.2s; background: #f9fafb; min-height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; }
.photo-upload-area:hover { border-color: #2563eb; background: #eff6ff; }
.photo-upload-area.dragover { border-color: #2563eb; background: #dbeafe; }
.photo-upload-area .upload-icon { font-size: 32px; }
.photo-upload-area p { margin: 0; color: #64748b; font-size: 14px; }
.photo-preview { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px; }
.photo-thumb { position: relative; width: 80px; height: 80px; border-radius: 12px; overflow: hidden; }
.photo-thumb img { width: 100%; height: 100%; object-fit: cover; }
.photo-thumb .remove-photo { position: absolute; top: 4px; right: 4px; background: rgba(239,68,68,0.9); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
.record-photos { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
.record-photos img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; cursor: pointer; }

/* Worker Hours Section */
.worker-hours-section { background: #f8fafc; border-radius: 12px; padding: 16px; margin-top: 12px; }
.worker-hours-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.worker-hours-header h4 { font-size: 14px; font-weight: 600; color: #475569; }
.worker-row { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid #e2e8f0; }
.worker-row:last-child { border-bottom: none; }
.worker-name { flex: 1; font-size: 15px; }
.worker-hours-input { width: 80px; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; text-align: center; background: white; }
.worker-hours-input:focus { outline: none; border-color: #2563eb; }
.add-worker-btn { padding: 10px 16px; background: #e2e8f0; color: #475569; border: none; border-radius: 10px; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 6px; min-height: 44px; }
.add-worker-btn:hover { background: #cbd5e1; }

/* Quick Notes Chips */
.quick-notes { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
.note-chip { padding: 10px 16px; background: #e2e8f0; border: none; border-radius: 20px; font-size: 14px; cursor: pointer; color: #475569; transition: all 0.2s; min-height: 40px; }
.note-chip:hover { background: #cbd5e1; }
.note-chip.selected { background: #2563eb; color: white; }

/* Running Totals */
.running-totals { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; padding: 16px; background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); border-radius: 16px; color: white; }
.total-item { text-align: center; }
.total-value { font-size: 28px; font-weight: 700; }
.total-label { font-size: 12px; opacity: 0.9; margin-top: 4px; }

/* Weather Display */
.weather-display { display: flex; align-items: center; gap: 10px; padding: 12px 16px; background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%); border-radius: 12px; color: white; margin-bottom: 16px; }
.weather-icon { font-size: 32px; }
.weather-info { flex: 1; }
.weather-condition { font-size: 15px; font-weight: 600; }
.weather-temps { font-size: 13px; opacity: 0.9; }
.weather-loading { opacity: 0.7; font-style: italic; }

/* Yards Input */
.yards-input-group { display: flex; align-items: center; gap: 12px; padding: 16px; background: #fef3c7; border-radius: 12px; margin-bottom: 16px; }
.yards-input-group .icon { font-size: 32px; }
.yards-input-group .input-wrapper { flex: 1; }
.yards-input-group label { display: block; font-size: 12px; color: #92400e; font-weight: 600; margin-bottom: 4px; }
.yards-input { width: 100%; padding: 12px; border: 2px solid #fcd34d; border-radius: 10px; font-size: 20px; font-weight: 700; text-align: center; background: white; }
.yards-input:focus { outline: none; border-color: #f59e0b; }

/* Mobile Responsive */
@media (max-width: 480px) {
  .modal-content { max-height: 100vh; border-radius: 0; }
  .running-totals { grid-template-columns: 1fr 1fr; }
  .worker-row { flex-wrap: wrap; }
  .worker-name { width: 100%; margin-bottom: 8px; }
}

/* Toast Notifications */
.toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; max-width: 90%; }
.toast { padding: 14px 20px; border-radius: 12px; color: white; font-size: 14px; font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: toastIn 0.3s ease-out; display: flex; align-items: center; gap: 10px; min-width: 280px; }
.toast.success { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); }
.toast.error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
.toast.warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
.toast.info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
.toast-icon { font-size: 20px; }
.toast-message { flex: 1; }
.toast-close { background: none; border: none; color: white; opacity: 0.7; cursor: pointer; font-size: 18px; padding: 0 4px; }
.toast-close:hover { opacity: 1; }
@keyframes toastIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes toastOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }

/* Form Validation Styles */
.input-group.error input, .input-group.error select, .input-group.error textarea { border-color: #ef4444; background: #fef2f2; }
.input-group.error label { color: #dc2626; }
.error-message { color: #dc2626; font-size: 12px; margin-top: 6px; display: flex; align-items: center; gap: 4px; }
.error-message::before { content: '‚ö†'; }
.input-group.success input, .input-group.success select { border-color: #22c55e; }
.yards-input-group.error { background: #fef2f2; border: 2px solid #ef4444; }
.yards-input-group.error .yards-input { border-color: #ef4444; }
.worker-hours-input.error { border-color: #ef4444; background: #fef2f2; }

/* Loading States */
.btn.loading { position: relative; color: transparent !important; pointer-events: none; }
.btn.loading::after { content: ''; position: absolute; width: 20px; height: 20px; top: 50%; left: 50%; margin-left: -10px; margin-top: -10px; border: 2px solid transparent; border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.btn:disabled { opacity: 0.6; cursor: not-allowed; }

/* Form Summary */
.form-summary { background: #f1f5f9; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
.form-summary h4 { font-size: 14px; color: #475569; margin-bottom: 12px; }
.summary-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0; font-size: 14px; }
.summary-row:last-child { border-bottom: none; }
.summary-label { color: #64748b; }
.summary-value { font-weight: 600; color: #1e293b; }
.summary-value.empty { color: #94a3b8; font-style: italic; font-weight: 400; }

/* Required field indicator */
.required::after { content: ' *'; color: #ef4444; }
</style>
</head>
<body>
<div id="app">
<div id="login-screen" class="screen active">
<div class="login-container">
<div class="logo"><h1>üèóÔ∏è</h1><h2>Foreman System</h2></div>
<div class="input-group"><label>Email</label><input type="email" id="email"></div>
<div class="input-group"><label>Password</label><input type="password" id="password"></div>
<button class="btn btn-primary btn-large" onclick="doLogin()">Login</button>
</div>
</div>
<div id="dashboard-screen" class="screen">
<header class="app-header"><button onclick="openMenu()" class="icon-btn">‚ò∞</button><h1 id="page-title">Schedule</h1><button class="icon-btn">üë§</button></header>
<nav id="side-menu" class="side-menu">
<div class="menu-header"><span>Welcome, Gentry</span><button onclick="closeMenu()" class="icon-btn">‚úï</button></div>
<ul class="menu-list">
<li class="menu-item" onclick="showView('today')">üìÖ Today</li>
<li class="menu-item active" onclick="showView('calendar')">üóìÔ∏è Schedule</li>
<li class="menu-item" onclick="showView('jobs')">üìã All Jobs</li>
<li class="menu-item" onclick="showView('concrete')">üöõ Concrete</li>
<li class="menu-item" onclick="window.location.href='/job-costing.html'">üí∞ Job Costing</li>
<li class="menu-item" onclick="showView('workers')">üë∑ Workers</li>
<li class="menu-item" onclick="doLogout()">üö™ Logout</li>
</ul>
</nav>
<div id="menu-overlay" class="menu-overlay" onclick="closeMenu()"></div>
<div id="jobs-sidebar" class="jobs-sidebar">
<div class="jobs-sidebar-header"><h3>Jobs</h3><button onclick="toggleJobsSidebar()" style="background:none;border:none;color:white;font-size:24px;cursor:pointer;">‚úï</button></div>
<div class="jobs-search"><input type="text" id="job-search" placeholder="Search jobs..." oninput="filterJobs()"></div>
<div class="jobs-list" id="jobs-list"></div>
</div>
<div id="jobs-overlay" class="menu-overlay" onclick="toggleJobsSidebar()"></div>
<main class="main-content">
<div id="today-view" class="view"></div>
<div id="calendar-view" class="view active"></div>
<div id="jobs-view" class="view"></div>
<div id="concrete-view" class="view"></div>
<div id="workers-view" class="view"></div>
</main>
<button class="toggle-jobs-btn" onclick="toggleJobsSidebar()">Jobs</button>
</div>
</div>
<!-- Toast Container -->
<div id="toast-container" class="toast-container"></div>
<script>
var API = '/api/public';
var API_BASE = '/api';
var defaultColors = ['#f97316','#22c55e','#a855f7','#ef4444','#3b82f6','#eab308'];
var jobs = [], concreteDeliveries = [], workers = [], dailyRecords = [], crewLeads = [], schedule = [], items = [], todaysJobs = [];
var currentMonth = new Date().getMonth();
var currentYear = new Date().getFullYear();
var draggedJobId = null;
var pendingPhotos = [];
var pendingWorkItems = [];
var pendingWorkerHours = [];
var selectedNotes = [];
var currentWeather = null;
var currentJobTotals = null;

// Quick note options for concrete work
var QUICK_NOTES = [
  'Poured footer', 'Poured stem wall', 'Poured flatwork', 'Set forms',
  'Stripped forms', 'Curb & gutter', 'Sidewalk', 'Driveway',
  'Garage floor', 'Basement floor', 'Finished concrete', 'Prep work'
];

// Form validation state
var formErrors = {};
var isSaving = false;

// ========== TOAST NOTIFICATIONS ==========
function showToast(message, type, duration) {
  type = type || 'info';
  duration = duration || 4000;

  var container = document.getElementById('toast-container');
  var toast = document.createElement('div');
  toast.className = 'toast ' + type;

  var icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };

  toast.innerHTML = '<span class="toast-icon">' + icons[type] + '</span>' +
    '<span class="toast-message">' + message + '</span>' +
    '<button class="toast-close" onclick="this.parentElement.remove()">‚úï</button>';

  container.appendChild(toast);

  // Auto-remove after duration
  setTimeout(function() {
    if (toast.parentElement) {
      toast.style.animation = 'toastOut 0.3s ease-out forwards';
      setTimeout(function() { toast.remove(); }, 300);
    }
  }, duration);
}

// ========== FORM VALIDATION ==========
function validateRequired(value, fieldName) {
  if (!value || (typeof value === 'string' && !value.trim())) {
    return fieldName + ' is required';
  }
  return null;
}

function validateNumber(value, fieldName, min, max) {
  if (value === '' || value === null || value === undefined) return null; // Optional
  var num = parseFloat(value);
  if (isNaN(num)) {
    return fieldName + ' must be a valid number';
  }
  if (min !== undefined && num < min) {
    return fieldName + ' must be at least ' + min;
  }
  if (max !== undefined && num > max) {
    return fieldName + ' cannot exceed ' + max;
  }
  return null;
}

function validateDate(value, fieldName) {
  if (!value) return fieldName + ' is required';
  var date = new Date(value);
  if (isNaN(date.getTime())) {
    return 'Invalid date format';
  }
  // Check if date is not too far in the future (more than 1 day)
  var tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  if (date > tomorrow) {
    return 'Date cannot be in the future';
  }
  return null;
}

function showFieldError(fieldId, message) {
  var field = document.getElementById(fieldId);
  if (!field) return;

  var inputGroup = field.closest('.input-group') || field.closest('.yards-input-group');
  if (inputGroup) {
    inputGroup.classList.add('error');
    inputGroup.classList.remove('success');

    // Remove existing error message
    var existingError = inputGroup.querySelector('.error-message');
    if (existingError) existingError.remove();

    // Add new error message
    if (message) {
      var errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.textContent = message;
      inputGroup.appendChild(errorDiv);
    }
  }

  formErrors[fieldId] = message;
}

function clearFieldError(fieldId) {
  var field = document.getElementById(fieldId);
  if (!field) return;

  var inputGroup = field.closest('.input-group') || field.closest('.yards-input-group');
  if (inputGroup) {
    inputGroup.classList.remove('error');
    var errorMsg = inputGroup.querySelector('.error-message');
    if (errorMsg) errorMsg.remove();
  }

  delete formErrors[fieldId];
}

function markFieldSuccess(fieldId) {
  var field = document.getElementById(fieldId);
  if (!field) return;

  var inputGroup = field.closest('.input-group');
  if (inputGroup) {
    inputGroup.classList.remove('error');
    inputGroup.classList.add('success');
  }

  delete formErrors[fieldId];
}

function clearAllErrors() {
  document.querySelectorAll('.input-group.error, .yards-input-group.error').forEach(function(el) {
    el.classList.remove('error');
  });
  document.querySelectorAll('.error-message').forEach(function(el) {
    el.remove();
  });
  formErrors = {};
}

function validateDailyRecordForm() {
  clearAllErrors();
  var isValid = true;

  // Validate Job (required)
  var jobId = document.getElementById('record-job').value;
  var jobError = validateRequired(jobId, 'Job');
  if (jobError) {
    showFieldError('record-job', jobError);
    isValid = false;
  } else {
    markFieldSuccess('record-job');
  }

  // Validate Date (required)
  var recordDate = document.getElementById('record-date').value;
  var dateError = validateDate(recordDate, 'Date');
  if (dateError) {
    showFieldError('record-date', dateError);
    isValid = false;
  } else {
    markFieldSuccess('record-date');
  }

  // Validate Yards (optional but must be valid if provided)
  var yards = document.getElementById('record-yards').value;
  var yardsError = validateNumber(yards, 'Yards', 0, 9999);
  if (yardsError) {
    showFieldError('record-yards', yardsError);
    isValid = false;
  }

  // Validate worker hours
  var invalidHours = false;
  pendingWorkerHours.forEach(function(wh, idx) {
    if (wh.hours_worked < 0 || wh.hours_worked > 24 || isNaN(wh.hours_worked)) {
      invalidHours = true;
    }
  });
  if (invalidHours) {
    showToast('Worker hours must be between 0 and 24', 'error');
    isValid = false;
  }

  // Check if there's at least some content
  var hasYards = yards && parseFloat(yards) > 0;
  var hasNotes = selectedNotes.length > 0 || document.getElementById('record-notes').value.trim();
  var hasWorkers = pendingWorkerHours.length > 0 && pendingWorkerHours.some(function(wh) { return wh.hours_worked > 0; });
  var hasWorkItems = pendingWorkItems.length > 0;
  var hasPhotos = pendingPhotos.length > 0;

  if (!hasYards && !hasNotes && !hasWorkers && !hasWorkItems && !hasPhotos) {
    showToast('Please add some content: yards poured, notes, worker hours, or photos', 'warning');
    isValid = false;
  }

  return isValid;
}

// ========== LOADING STATES ==========
function setButtonLoading(buttonEl, loading) {
  if (loading) {
    buttonEl.classList.add('loading');
    buttonEl.disabled = true;
  } else {
    buttonEl.classList.remove('loading');
    buttonEl.disabled = false;
  }
}

// ========== API ERROR HANDLING ==========
async function apiRequest(url, options) {
  options = options || {};

  try {
    var response = await fetch(url, options);

    if (!response.ok) {
      var errorData;
      try {
        errorData = await response.json();
      } catch(e) {
        errorData = { error: 'Request failed with status ' + response.status };
      }
      throw new Error(errorData.error || errorData.message || 'Request failed');
    }

    // Check if response has content
    var contentType = response.headers.get('content-type');
    if (contentType && contentType.includes('application/json')) {
      return await response.json();
    }
    return null;

  } catch (error) {
    if (error.name === 'TypeError' && error.message.includes('fetch')) {
      throw new Error('Network error. Please check your connection.');
    }
    throw error;
  }
}

async function doLogin() {
  document.getElementById('login-screen').style.display='none';
  document.getElementById('dashboard-screen').style.display='block';
  await loadAllData();
  showView('today');
}

async function loadAllData() {
  try { jobs = await (await fetch(API+'/jobs')).json(); } catch(e) { jobs = []; }
  try { concreteDeliveries = await (await fetch(API+'/concrete2')).json(); } catch(e) { concreteDeliveries = []; }
  try { workers = await (await fetch(API+'/workers')).json(); } catch(e) { workers = []; }
  try { dailyRecords = await (await fetch(API+'/daily-records')).json(); } catch(e) { dailyRecords = []; }
  try { crewLeads = await (await fetch(API+'/crew-leads')).json(); } catch(e) { crewLeads = []; }
  try { schedule = await (await fetch(API+'/schedule')).json(); } catch(e) { schedule = []; }
  try { items = await (await fetch(API+'/items')).json(); } catch(e) { items = []; }
  try { todaysJobs = await (await fetch(API+'/schedule/today')).json(); } catch(e) { todaysJobs = []; }
  renderJobsSidebar();
}

function doLogout() { document.getElementById('dashboard-screen').style.display='none'; document.getElementById('login-screen').style.display='block'; closeMenu(); }
function openMenu() { document.getElementById('side-menu').classList.add('open'); document.getElementById('menu-overlay').classList.add('open'); }
function closeMenu() { document.getElementById('side-menu').classList.remove('open'); document.getElementById('menu-overlay').classList.remove('open'); }
function toggleJobsSidebar() { document.getElementById('jobs-sidebar').classList.toggle('open'); document.getElementById('jobs-overlay').classList.toggle('open'); }

function renderJobsSidebar(filter) {
  var activeJobs = jobs.filter(function(j) { return j.status !== 'closed'; });
  var closedJobs = jobs.filter(function(j) { return j.status === 'closed'; });
  var all = activeJobs.concat(closedJobs);
  if(filter) {
    var f = filter.toLowerCase();
    all = all.filter(function(j) { return j.job_number.toLowerCase().includes(f) || j.job_name.toLowerCase().includes(f) || (j.location && j.location.toLowerCase().includes(f)); });
  }
  var html = '';
  var activeFiltered = all.filter(function(j) { return j.status !== 'closed'; });
  var closedFiltered = all.filter(function(j) { return j.status === 'closed'; });
  activeFiltered.forEach(function(j) {
    html += '<div class="sidebar-job" draggable="true" ondragstart="dragStart(event,'+j.id+')"><div style="display:flex;justify-content:space-between;align-items:start;"><div><div style="font-weight:bold;color:#2563eb;">#'+j.job_number+'</div><div style="font-size:14px;margin-top:4px;">'+j.job_name+'</div><div style="font-size:12px;color:#666;margin-top:4px;">üìç '+(j.location||'No location')+'</div></div><button onclick="event.stopPropagation();closeJob('+j.id+')" style="padding:4px 8px;background:#ef4444;color:white;border:none;border-radius:4px;font-size:11px;cursor:pointer;">Close</button></div></div>';
  });
  if(closedFiltered.length > 0) {
    html += '<div style="padding:10px 15px;margin-top:15px;border-top:2px solid #e5e7eb;color:#666;font-weight:bold;">Closed Jobs</div>';
    closedFiltered.forEach(function(j) {
      html += '<div class="sidebar-job closed" draggable="true" ondragstart="dragStart(event,'+j.id+')"><div style="display:flex;justify-content:space-between;align-items:start;"><div><div style="font-weight:bold;color:#9ca3af;">#'+j.job_number+'</div><div style="font-size:14px;margin-top:4px;">'+j.job_name+'</div><div style="font-size:12px;color:#666;margin-top:4px;">üìç '+(j.location||'No location')+'</div></div><button onclick="event.stopPropagation();reopenJob('+j.id+')" style="padding:4px 8px;background:#22c55e;color:white;border:none;border-radius:4px;font-size:11px;cursor:pointer;">Reopen</button></div></div>';
    });
  }
  document.getElementById('jobs-list').innerHTML = html || '<p style="padding:15px;color:#666;">No jobs found.</p>';
}

function filterJobs() { renderJobsSidebar(document.getElementById('job-search').value); }

async function closeJob(id) {
  await fetch(API_BASE+'/jobs/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:'closed'})});
  await loadAllData();
}

async function reopenJob(id) {
  await fetch(API_BASE+'/jobs/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:'active'})});
  await loadAllData();
}

async function showView(view) {
  if(view === 'calendar') { try { schedule = await (await fetch(API+'/schedule')).json(); } catch(e) { schedule = []; } }
  if(view === 'today') { try { todaysJobs = await (await fetch(API+'/schedule/today')).json(); } catch(e) { todaysJobs = []; } }
  document.querySelectorAll('.view').forEach(function(v){v.style.display='none';});
  document.querySelectorAll('.menu-item').forEach(function(m){m.classList.remove('active');});
  document.getElementById(view+'-view').style.display='block';
  closeMenu();
  var titles = {today:"Today", calendar:'Schedule', jobs:'All Jobs', concrete:'Concrete', workers:'Workers'};
  document.getElementById('page-title').textContent = titles[view];
  if(view==='today') renderToday();
  else if(view==='calendar') renderCalendar();
  else if(view==='jobs') renderJobs();
  else if(view==='concrete') renderConcrete();
  else if(view==='workers') renderWorkers();
}

async function renderToday() {
  var today = new Date().toISOString().split('T')[0];
  var todayRecords = dailyRecords.filter(function(r) { return r.record_date && r.record_date.split('T')[0] === today; });

  var html = '';

  // Today's Jobs Section - Quick Add
  html += '<div class="todays-jobs">';
  html += '<div class="todays-jobs-header"><h3>üìã TODAY\'S JOBS</h3></div>';

  if(todaysJobs.length > 0) {
    todaysJobs.forEach(function(job) {
      var hasRecord = parseInt(job.has_record) > 0;
      html += '<div class="job-card '+(hasRecord ? 'has-record' : '')+'" style="border-left-color:'+(job.color||'#22c55e')+'">';
      html += '<div class="job-card-header">';
      html += '<div class="job-card-info">';
      html += '<h4><span class="job-number">#'+job.job_number+'</span> '+job.job_name+'</h4>';
      html += '<div class="job-meta">üìç '+(job.location||'No location')+'</div>';
      html += '</div>';
      if(job.crew_lead_name) {
        html += '<div class="job-card-crew"><div class="crew-dot" style="background:'+(job.color||'#22c55e')+'"></div>'+job.crew_lead_name+'</div>';
      }
      html += '</div>';
      html += '<div class="job-card-actions">';
      if(hasRecord) {
        html += '<button class="quick-add-btn done" disabled>‚úì Record Added</button>';
      } else {
        html += '<button class="quick-add-btn" onclick="openDailyModalForJob('+job.job_id+')">+ Add Daily Record</button>';
      }
      html += '</div>';
      html += '</div>';
    });
  } else {
    html += '<div style="text-align:center;padding:30px;background:white;border-radius:16px;color:#64748b;">';
    html += '<div style="font-size:48px;margin-bottom:12px;">üìÖ</div>';
    html += '<p>No jobs scheduled for today</p>';
    html += '<button onclick="showView(\'calendar\')" class="btn btn-primary" style="margin-top:16px;">View Calendar</button>';
    html += '</div>';
  }
  html += '</div>';

  // All Jobs Quick Add
  html += '<div style="margin-bottom:24px;">';
  html += '<button onclick="openDailyModal()" class="btn btn-success btn-large" style="width:100%;">+ Add Daily Record for Any Job</button>';
  html += '</div>';

  // Today's Records
  html += '<h3 style="padding:15px 0;color:#64748b;font-size:16px;">üìù TODAY\'S RECORDS ('+todayRecords.length+')</h3>';

  if(todayRecords.length > 0) {
    for(var i = 0; i < todayRecords.length; i++) {
      var r = todayRecords[i];
      var photosHtml = await getRecordPhotosHtml(r.id);
      var weatherHtml = getWeatherHtml(r.weather_data);
      var workItemsHtml = await getWorkItemsHtml(r.id);
      var workerHoursHtml = await getWorkerHoursHtml(r.id);
      html += '<div style="background:white;border-left:4px solid #22c55e;padding:16px;margin:10px 0;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">';
      html += '<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">';
      html += '<div><div style="font-weight:bold;color:#22c55e;font-size:15px;">#'+(r.job_number||'')+' - '+(r.job_name||'')+'</div>';
      html += '<div style="color:#64748b;font-size:13px;margin-top:4px;">üë∑ '+(r.foreman_name||'No foreman')+'</div></div>';
      html += weatherHtml;
      html += '</div>';
      html += workItemsHtml;
      html += workerHoursHtml;
      if(r.notes) {
        html += '<div style="margin-top:12px;padding:12px;background:#f1f5f9;border-radius:10px;font-size:14px;color:#475569;">'+r.notes+'</div>';
      }
      html += photosHtml;
      html += '<button onclick="openAddPhotosModal('+r.id+')" style="margin-top:12px;padding:12px 20px;background:#3b82f6;color:white;border:none;border-radius:10px;font-size:14px;cursor:pointer;min-height:44px;">üì∑ Add Photos</button>';
      html += '</div>';
    }
  } else {
    html += '<p style="color:#64748b;text-align:center;padding:20px;">No records for today yet.</p>';
  }

  document.getElementById('today-view').innerHTML = html;
}

async function getWorkItemsHtml(recordId) {
  try {
    var workItems = await (await fetch(API_BASE+'/daily-records/'+recordId+'/work-items')).json();
    if(workItems.length === 0) return '';
    var html = '<div style="margin-top:12px;"><strong style="font-size:12px;color:#64748b;text-transform:uppercase;">Work Completed:</strong><div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;">';
    workItems.forEach(function(w) {
      html += '<span style="background:#dbeafe;color:#1e40af;padding:6px 12px;border-radius:8px;font-size:13px;font-weight:500;">'+w.quantity+' '+w.unit_of_measure+' - '+w.item_name+'</span>';
    });
    html += '</div></div>';
    return html;
  } catch(e) { return ''; }
}

async function getWorkerHoursHtml(recordId) {
  try {
    var res = await fetch(API_BASE+'/daily-records/'+recordId+'/worker-hours');
    if (!res.ok) return '';
    var workerHours = await res.json();
    if(workerHours.length === 0) return '';
    var totalHours = workerHours.reduce(function(sum, wh) { return sum + parseFloat(wh.hours_worked); }, 0);
    var html = '<div style="margin-top:12px;"><strong style="font-size:12px;color:#64748b;text-transform:uppercase;">Worker Hours ('+totalHours.toFixed(1)+' total):</strong><div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;">';
    workerHours.forEach(function(wh) {
      html += '<span style="background:#fef3c7;color:#92400e;padding:6px 12px;border-radius:8px;font-size:13px;font-weight:500;">'+wh.full_name+': '+wh.hours_worked+'h</span>';
    });
    html += '</div></div>';
    return html;
  } catch(e) { return ''; }
}

function getWeatherHtml(weatherData) {
  if(!weatherData) return '';
  var w = typeof weatherData === 'string' ? JSON.parse(weatherData) : weatherData;
  var icon = getWeatherIcon(w.code);
  return '<div style="background:linear-gradient(135deg,#0ea5e9,#38bdf8);padding:8px 12px;border-radius:10px;font-size:13px;display:flex;align-items:center;gap:8px;color:white;"><span style="font-size:20px;">'+icon+'</span><span>'+w.condition+'</span><span style="opacity:0.9;">'+w.high+'¬∞/'+w.low+'¬∞F</span></div>';
}

function getWeatherIcon(code) {
  if(code === 0 || code === 1) return '‚òÄÔ∏è';
  if(code === 2) return '‚õÖ';
  if(code === 3) return '‚òÅÔ∏è';
  if(code >= 45 && code <= 48) return 'üå´Ô∏è';
  if(code >= 51 && code <= 55) return 'üåßÔ∏è';
  if(code >= 61 && code <= 65) return 'üåßÔ∏è';
  if(code >= 71 && code <= 77) return '‚ùÑÔ∏è';
  if(code >= 80 && code <= 82) return 'üå¶Ô∏è';
  if(code >= 85 && code <= 86) return 'üå®Ô∏è';
  if(code >= 95) return '‚õàÔ∏è';
  return 'üå°Ô∏è';
}

async function getRecordPhotosHtml(recordId) {
  try {
    var photos = await (await fetch(API_BASE+'/daily-records/'+recordId+'/photos')).json();
    if(photos.length === 0) return '';
    var html = '<div class="record-photos" style="margin-top:12px;">';
    photos.forEach(function(p) {
      html += '<img src="'+p.file_path+'" onclick="openPhotoViewer(\''+p.file_path+'\')" alt="Photo">';
    });
    html += '</div>';
    return html;
  } catch(e) { return ''; }
}

function openPhotoViewer(src) {
  var modal = document.createElement('div'); modal.id='photo-viewer'; modal.className='modal'; modal.style.display='flex'; modal.style.alignItems='center';
  modal.innerHTML = '<div style="position:relative;max-width:90%;max-height:90%;"><img src="'+src+'" style="max-width:100%;max-height:90vh;border-radius:12px;"><button onclick="document.getElementById(\'photo-viewer\').remove()" style="position:absolute;top:-12px;right:-12px;background:#ef4444;color:white;border:none;border-radius:50%;width:36px;height:36px;font-size:20px;cursor:pointer;">‚úï</button></div>';
  modal.onclick = function(e) { if(e.target === modal) modal.remove(); };
  document.body.appendChild(modal);
}

function renderCalendar() {
  var monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  var firstDay = new Date(currentYear, currentMonth, 1).getDay();
  var daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
  var todayStr = new Date().toISOString().split('T')[0];
  var html = '<div class="calendar-box"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;"><button onclick="prevMonth()" class="btn btn-primary">‚óÄ</button><h2 style="margin:0;">'+monthNames[currentMonth]+' '+currentYear+'</h2><button onclick="nextMonth()" class="btn btn-primary">‚ñ∂</button></div>';
  html += '<div class="calendar-grid"><div class="calendar-header">Sun</div><div class="calendar-header">Mon</div><div class="calendar-header">Tue</div><div class="calendar-header">Wed</div><div class="calendar-header">Thu</div><div class="calendar-header">Fri</div><div class="calendar-header">Sat</div>';
  for(var i=0;i<firstDay;i++) html += '<div class="calendar-day" style="background:#f9fafb;"></div>';
  for(var day=1;day<=daysInMonth;day++) {
    var dateStr = currentYear+'-'+String(currentMonth+1).padStart(2,'0')+'-'+String(day).padStart(2,'0');
    var daySchedule = schedule.filter(function(s){return s.scheduled_date && s.scheduled_date.split('T')[0]===dateStr;});
    var isToday = dateStr===todayStr;
    var tags = daySchedule.slice(0,3).map(function(s){return '<div class="job-tag" style="background:'+(s.color||'#22c55e')+';">'+(s.job_number||'Job')+'</div>';}).join('');
    if(daySchedule.length>3) tags += '<div style="font-size:10px;color:#666;">+'+(daySchedule.length-3)+' more</div>';
    html += '<div class="calendar-day'+(isToday?' today':'')+'" onclick="openDayView(\''+dateStr+'\')" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="dropJob(event,\''+dateStr+'\')"><div style="font-weight:bold;color:'+(isToday?'#2563eb':'#333')+';">'+day+'</div>'+tags+'</div>';
  }
  html += '</div></div><div class="crew-legend"><strong>Crew Leads:</strong>';
  crewLeads.forEach(function(c){html += '<div class="crew-item"><div class="crew-color" style="background:'+c.color+';"></div><span>'+c.name+'</span></div>';});
  html += '</div>';
  document.getElementById('calendar-view').innerHTML = html;
}

function prevMonth() { currentMonth--; if(currentMonth<0){currentMonth=11;currentYear--;} renderCalendar(); }
function nextMonth() { currentMonth++; if(currentMonth>11){currentMonth=0;currentYear++;} renderCalendar(); }
function dragStart(e,id) { draggedJobId=id; e.dataTransfer.effectAllowed='move'; }
function dragOver(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
function dragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
function dropJob(e,dateStr) { e.preventDefault(); e.currentTarget.classList.remove('drag-over'); if(draggedJobId){toggleJobsSidebar();openScheduleModal(dateStr,draggedJobId);draggedJobId=null;} }

function openDayView(dateStr) {
  var daySchedule = schedule.filter(function(s){return s.scheduled_date && s.scheduled_date.split('T')[0]===dateStr;});
  var formatted = new Date(dateStr+'T12:00:00').toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  var jobsHtml = daySchedule.length>0 ? daySchedule.map(function(s){return '<div style="background:#f9fafb;border-left:4px solid '+(s.color||'#22c55e')+';padding:15px;margin:10px 0;border-radius:8px;"><div style="font-weight:bold;">#'+(s.job_number||'')+' - '+(s.job_name||'')+'</div><div style="color:#666;margin:5px 0;">üìç '+(s.location||'No location')+'</div><div style="color:'+(s.color||'#22c55e')+';font-weight:bold;">üë∑ '+(s.crew_lead_name||'No crew lead')+'</div>'+(s.notes?'<div style="margin-top:8px;padding:8px;background:#e5e7eb;border-radius:6px;">'+s.notes+'</div>':'')+'</div>';}).join('') : '<p style="color:#666;">No jobs scheduled.</p>';
  var modal = document.createElement('div'); modal.id='day-modal'; modal.className='modal'; modal.style.display='flex';
  modal.innerHTML = '<div class="modal-content" style="max-width:500px;"><div class="modal-header"><h2>'+formatted+'</h2><button onclick="document.getElementById(\'day-modal\').remove()" class="icon-btn">‚úï</button></div><div class="modal-body">'+jobsHtml+'<button onclick="document.getElementById(\'day-modal\').remove();openScheduleModal(\''+dateStr+'\')" style="width:100%;margin-top:15px;padding:14px;background:#2563eb;color:white;border:none;border-radius:12px;font-size:16px;cursor:pointer;min-height:52px;">+ Schedule Job</button><button onclick="document.getElementById(\'day-modal\').remove();openDailyModalForDate(\''+dateStr+'\')" style="width:100%;margin-top:10px;padding:14px;background:#22c55e;color:white;border:none;border-radius:12px;font-size:16px;cursor:pointer;min-height:52px;">+ Add Daily Record</button></div></div>';
  document.body.appendChild(modal);
}

function openScheduleModal(presetDate,presetJobId) {
  var jobOpts = jobs.map(function(j){return '<option value="'+j.id+'"'+(presetJobId==j.id?' selected':'')+'>#'+j.job_number+' - '+j.job_name+'</option>';}).join('');
  var crewOpts = crewLeads.map(function(c){return '<option value="'+c.id+'">'+c.name+'</option>';}).join('');
  var modal = document.createElement('div'); modal.id='schedule-modal'; modal.className='modal'; modal.style.display='flex';
  modal.innerHTML = '<div class="modal-content"><div class="modal-header"><h2>Schedule Job</h2><button onclick="document.getElementById(\'schedule-modal\').remove()" class="icon-btn">‚úï</button></div><div class="modal-body"><div class="input-group"><label>Date</label><input type="date" id="schedule-date" value="'+(presetDate||new Date().toISOString().split('T')[0])+'"></div><div class="input-group"><label>Job</label><select id="schedule-job"><option value="">Select Job</option>'+jobOpts+'</select></div><div class="input-group"><label>Crew Lead</label><select id="schedule-crew"><option value="">Select Crew Lead</option>'+crewOpts+'</select></div><div class="input-group"><label>Notes</label><textarea id="schedule-notes" rows="3" placeholder="Notes..."></textarea></div></div><div class="modal-footer"><button onclick="document.getElementById(\'schedule-modal\').remove()" class="btn btn-secondary">Cancel</button><button onclick="saveSchedule()" class="btn btn-primary">Schedule</button></div></div>';
  document.body.appendChild(modal);
}

async function saveSchedule() {
  var data = {job_id:document.getElementById('schedule-job').value,scheduled_date:document.getElementById('schedule-date').value,crew_lead_id:document.getElementById('schedule-crew').value||null,notes:document.getElementById('schedule-notes').value.trim()};
  if(!data.job_id||!data.scheduled_date){alert('Job and Date required!');return;}
  var res = await fetch(API+'/schedule',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
  if(res.ok){document.getElementById('schedule-modal').remove();if(document.getElementById('day-modal'))document.getElementById('day-modal').remove();schedule=await(await fetch(API+'/schedule')).json();renderCalendar();alert('Scheduled!');}
}

function renderJobs() {
  var html = '<h3 style="padding:15px 0;">All Jobs ('+jobs.length+')</h3><button onclick="openJobModal()" style="margin-bottom:15px;padding:14px 30px;background:#2563eb;color:white;border:none;border-radius:12px;font-size:16px;cursor:pointer;min-height:52px;">+ Add Job</button>';
  jobs.forEach(function(j,i){html += '<div style="background:white;border-left:4px solid '+defaultColors[i%defaultColors.length]+';padding:15px;margin:10px 0;border-radius:12px;box-shadow:0 2px 4px rgba(0,0,0,0.1);"><div style="font-weight:bold;color:#666;">#'+j.job_number+'</div><div style="font-size:18px;font-weight:bold;margin:5px 0;">'+j.job_name+'</div><div style="color:#666;">üìç '+(j.location||'No location')+'</div></div>';});
  document.getElementById('jobs-view').innerHTML = html;
}

function renderConcrete() {
  var html = '<h3 style="padding:15px 0;">Concrete ('+concreteDeliveries.length+')</h3><button onclick="openConcreteModal()" style="margin-bottom:15px;padding:14px 30px;background:#f97316;color:white;border:none;border-radius:12px;font-size:16px;cursor:pointer;min-height:52px;">+ Add Delivery</button>';
  concreteDeliveries.forEach(function(c){html += '<div style="background:white;border-left:4px solid #f97316;padding:15px;margin:10px 0;border-radius:12px;box-shadow:0 2px 4px rgba(0,0,0,0.1);"><div style="font-weight:bold;color:#f97316;">#'+(c.invoice_number||'')+'</div><div>'+(c.yards||c.cubic_yards||'?')+' yards</div><div style="color:#666;">'+(c.delivery_date?new Date(c.delivery_date).toLocaleDateString():'')+'</div></div>';});
  document.getElementById('concrete-view').innerHTML = html;
}

function renderWorkers() {
  var html = '<h3 style="padding:15px 0;">Workers ('+workers.length+')</h3><button onclick="openWorkerModal()" style="margin-bottom:15px;padding:14px 30px;background:#a855f7;color:white;border:none;border-radius:12px;font-size:16px;cursor:pointer;min-height:52px;">+ Add Worker</button>';
  workers.forEach(function(w){html += '<div style="background:white;border-left:4px solid #a855f7;padding:15px;margin:10px 0;border-radius:12px;box-shadow:0 2px 4px rgba(0,0,0,0.1);"><div style="font-size:18px;font-weight:bold;">'+w.full_name+'</div><div style="color:#666;">'+(w.role||'')+'</div></div>';});
  document.getElementById('workers-view').innerHTML = html;
}

function openJobModal() {
  var modal = document.createElement('div'); modal.id='job-modal'; modal.className='modal'; modal.style.display='flex';
  modal.innerHTML = '<div class="modal-content"><div class="modal-header"><h2>Add Job</h2><button onclick="document.getElementById(\'job-modal\').remove()" class="icon-btn">‚úï</button></div><div class="modal-body"><div class="input-group"><label>Job Number</label><input type="text" id="new-job-number"></div><div class="input-group"><label>Job Name</label><input type="text" id="new-job-name"></div><div class="input-group"><label>Location</label><input type="text" id="new-job-location"></div><div class="input-group"><label>Contractor</label><input type="text" id="new-job-contractor"></div></div><div class="modal-footer"><button onclick="document.getElementById(\'job-modal\').remove()" class="btn btn-secondary">Cancel</button><button onclick="saveNewJob()" class="btn btn-primary">Save</button></div></div>';
  document.body.appendChild(modal);
}

async function saveNewJob() {
  var data = {job_number:document.getElementById('new-job-number').value.trim(),job_name:document.getElementById('new-job-name').value.trim(),location:document.getElementById('new-job-location').value.trim(),contractor_name:document.getElementById('new-job-contractor').value.trim()};
  if(!data.job_number||!data.job_name){alert('Job Number and Name required!');return;}
  var res = await fetch(API_BASE+'/jobs',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
  if(res.ok){document.getElementById('job-modal').remove();await loadAllData();showView('jobs');alert('Job added!');}
}

function openConcreteModal() {
  var jobOpts = jobs.map(function(j){return '<option value="'+j.id+'">#'+j.job_number+' - '+j.job_name+'</option>';}).join('');
  var modal = document.createElement('div'); modal.id='concrete-modal'; modal.className='modal'; modal.style.display='flex';
  modal.innerHTML = '<div class="modal-content"><div class="modal-header"><h2>Add Concrete</h2><button onclick="document.getElementById(\'concrete-modal\').remove()" class="icon-btn">‚úï</button></div><div class="modal-body"><div class="input-group"><label>Invoice #</label><input type="text" id="concrete-invoice"></div><div class="input-group"><label>Supplier</label><select id="concrete-supplier"><option value="">Select</option><option value="JACK B PARSON">Jack B Parson</option><option value="GENEVA ROCK">Geneva Rock</option><option value="QUICKCRETE">Quickcrete</option></select></div><div class="input-group"><label>Date</label><input type="date" id="concrete-date" value="'+new Date().toISOString().split('T')[0]+'"></div><div class="input-group"><label>Yards</label><input type="number" id="concrete-yards" step="0.25"></div><div class="input-group"><label>Cost</label><input type="number" id="concrete-cost" step="0.01"></div><div class="input-group"><label>Job</label><select id="concrete-job"><option value="">Select</option>'+jobOpts+'</select></div></div><div class="modal-footer"><button onclick="document.getElementById(\'concrete-modal\').remove()" class="btn btn-secondary">Cancel</button><button onclick="saveConcrete()" class="btn btn-primary">Save</button></div></div>';
  document.body.appendChild(modal);
}

async function saveConcrete() {
  var data = {invoice_number:document.getElementById('concrete-invoice').value.trim(),supplier:document.getElementById('concrete-supplier').value,delivery_date:document.getElementById('concrete-date').value,yards:document.getElementById('concrete-yards').value,cost:document.getElementById('concrete-cost').value,job_id:document.getElementById('concrete-job').value||null};
  if(!data.invoice_number||!data.supplier||!data.delivery_date||!data.yards||!data.cost){alert('Fill all fields!');return;}
  var res = await fetch(API+'/concrete2',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
  if(res.ok){document.getElementById('concrete-modal').remove();await loadAllData();showView('concrete');alert('Added!');}
}

function openWorkerModal() {
  var modal = document.createElement('div'); modal.id='worker-modal'; modal.className='modal'; modal.style.display='flex';
  modal.innerHTML = '<div class="modal-content"><div class="modal-header"><h2>Add Worker</h2><button onclick="document.getElementById(\'worker-modal\').remove()" class="icon-btn">‚úï</button></div><div class="modal-body"><div class="input-group"><label>Name</label><input type="text" id="worker-name"></div><div class="input-group"><label>Role</label><input type="text" id="worker-role"></div><div class="input-group"><label>Contact</label><input type="text" id="worker-contact"></div></div><div class="modal-footer"><button onclick="document.getElementById(\'worker-modal\').remove()" class="btn btn-secondary">Cancel</button><button onclick="saveWorker()" class="btn btn-primary">Save</button></div></div>';
  document.body.appendChild(modal);
}

async function saveWorker() {
  var data = {full_name:document.getElementById('worker-name').value.trim(),role:document.getElementById('worker-role').value.trim(),contact_info:document.getElementById('worker-contact').value.trim()};
  if(!data.full_name){alert('Name required!');return;}
  var res = await fetch(API+'/workers',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
  if(res.ok){document.getElementById('worker-modal').remove();await loadAllData();showView('workers');alert('Added!');}
}

function openDailyModal() { openDailyModalForDate(new Date().toISOString().split('T')[0]); }

function openDailyModalForJob(jobId) {
  openDailyModalForDate(new Date().toISOString().split('T')[0], jobId);
}

async function openDailyModalForDate(dateStr, presetJobId) {
  pendingPhotos = [];
  pendingWorkItems = [];
  pendingWorkerHours = [];
  selectedNotes = [];
  currentWeather = null;
  currentJobTotals = null;

  var jobOpts = jobs.map(function(j){
    var selected = presetJobId && presetJobId == j.id ? ' selected' : '';
    return '<option value="'+j.id+'"'+selected+'>#'+j.job_number+' - '+j.job_name+'</option>';
  }).join('');

  var modal = document.createElement('div');
  modal.id='daily-modal';
  modal.className='modal';
  modal.style.display='flex';

  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h2>üìã Daily Record</h2>
        <button onclick="document.getElementById('daily-modal').remove()" class="icon-btn">‚úï</button>
      </div>
      <div class="modal-body" style="padding-bottom:100px;">

        <!-- Weather Display -->
        <div id="weather-display" class="weather-display">
          <div class="weather-icon">üå°Ô∏è</div>
          <div class="weather-info">
            <div class="weather-condition weather-loading">Loading weather...</div>
          </div>
        </div>

        <!-- Date & Job Selection -->
        <div class="input-group">
          <label class="required">Date</label>
          <input type="date" id="record-date" value="${dateStr}" required>
        </div>

        <div class="input-group">
          <label class="required">Job</label>
          <select id="record-job" onchange="onJobSelected()" required>
            <option value="">Select Job</option>
            ${jobOpts}
          </select>
        </div>

        <!-- Running Totals (shown after job selected) -->
        <div id="running-totals-container"></div>

        <!-- Yards Poured -->
        <div class="yards-input-group">
          <div class="icon">üèóÔ∏è</div>
          <div class="input-wrapper">
            <label>YARDS POURED TODAY</label>
            <input type="number" id="record-yards" class="yards-input" placeholder="0" step="0.25" min="0" inputmode="decimal">
          </div>
        </div>

        <!-- Quick Notes -->
        <div class="input-group">
          <label>What was done?</label>
          <div class="quick-notes" id="quick-notes">
            ${QUICK_NOTES.map(function(note) {
              return '<button type="button" class="note-chip" onclick="toggleNote(this, \''+note+'\')">'+note+'</button>';
            }).join('')}
          </div>
          <textarea id="record-notes" rows="2" placeholder="Additional notes..." style="margin-top:8px;"></textarea>
        </div>

        <!-- Worker Hours -->
        <div class="worker-hours-section">
          <div class="worker-hours-header">
            <h4>üë∑ Worker Hours</h4>
            <button type="button" class="add-worker-btn" onclick="openAddWorkerHoursModal()">+ Add Worker</button>
          </div>
          <div id="worker-hours-list">
            <p style="color:#94a3b8;font-size:14px;text-align:center;padding:12px;">No workers added yet</p>
          </div>
        </div>

        <!-- Work Items -->
        <div class="input-group" style="margin-top:16px;">
          <label>üì¶ Work Items (Optional)</label>
          <div style="display:flex;gap:8px;margin-top:5px;">
            <input type="text" id="item-search" placeholder="Search items..." style="flex:1;" oninput="filterItemsList()">
            <button type="button" onclick="toggleItemDropdown()" style="padding:12px 16px;background:#2563eb;color:white;border:none;border-radius:10px;cursor:pointer;min-height:48px;">+ Add</button>
          </div>
          <div id="item-dropdown" style="display:none;max-height:200px;overflow-y:auto;border:1px solid #ddd;border-radius:12px;margin-top:5px;background:white;"></div>
          <div id="pending-items-list" style="margin-top:10px;"></div>
        </div>

        <!-- Photos -->
        <div class="input-group">
          <label>üì∑ Photos</label>
          <div class="photo-upload-area" id="photo-upload-area" onclick="document.getElementById('photo-input').click()">
            <input type="file" id="photo-input" multiple accept="image/*" capture="environment" style="display:none;" onchange="handlePhotoSelect(event)">
            <div class="upload-icon">üì∑</div>
            <p>Tap to take photo or select from gallery</p>
          </div>
          <div class="photo-preview" id="photo-preview"></div>
        </div>

      </div>
      <div class="modal-footer">
        <button onclick="document.getElementById('daily-modal').remove()" class="btn btn-secondary">Cancel</button>
        <button onclick="saveDailyRecord()" class="btn btn-success">Save Record</button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  // Setup drag and drop for photos
  var uploadArea = document.getElementById('photo-upload-area');
  uploadArea.addEventListener('dragover', function(e) { e.preventDefault(); this.classList.add('dragover'); });
  uploadArea.addEventListener('dragleave', function(e) { e.preventDefault(); this.classList.remove('dragover'); });
  uploadArea.addEventListener('drop', function(e) { e.preventDefault(); this.classList.remove('dragover'); handlePhotoSelect({target:{files:e.dataTransfer.files}}); });

  // Initialize item dropdown
  renderItemDropdown();

  // Setup real-time validation
  setupFormValidation();

  // Load weather
  loadWeather();

  // If job is preset, load its data
  if(presetJobId) {
    onJobSelected();
  }
}

async function loadWeather() {
  try {
    var res = await fetch(API+'/weather');
    if(res.ok) {
      currentWeather = await res.json();
      var icon = getWeatherIcon(currentWeather.code);
      document.getElementById('weather-display').innerHTML = `
        <div class="weather-icon">${icon}</div>
        <div class="weather-info">
          <div class="weather-condition">${currentWeather.condition}</div>
          <div class="weather-temps">High: ${currentWeather.high}¬∞F ‚Ä¢ Low: ${currentWeather.low}¬∞F</div>
        </div>
      `;
    }
  } catch(e) {
    document.getElementById('weather-display').innerHTML = `
      <div class="weather-icon">üå°Ô∏è</div>
      <div class="weather-info">
        <div class="weather-condition">Weather unavailable</div>
      </div>
    `;
  }
}

async function onJobSelected() {
  var jobId = document.getElementById('record-job').value;
  var dateStr = document.getElementById('record-date').value;

  if(!jobId) {
    document.getElementById('running-totals-container').innerHTML = '';
    pendingWorkerHours = [];
    renderWorkerHoursList();
    return;
  }

  // Load running totals
  try {
    var res = await fetch(API+'/jobs/'+jobId+'/totals');
    if(res.ok) {
      currentJobTotals = await res.json();
      document.getElementById('running-totals-container').innerHTML = `
        <div class="running-totals">
          <div class="total-item">
            <div class="total-value">${currentJobTotals.total_yards.toFixed(1)}</div>
            <div class="total-label">Total Yards Poured</div>
          </div>
          <div class="total-item">
            <div class="total-value">${currentJobTotals.total_hours.toFixed(1)}</div>
            <div class="total-label">Total Hours Logged</div>
          </div>
        </div>
      `;
    }
  } catch(e) { console.error('Failed to load totals', e); }

  // Load suggested crew
  try {
    var res = await fetch(API+'/jobs/'+jobId+'/crew/'+dateStr);
    if(res.ok) {
      var crewData = await res.json();

      // Auto-populate with suggested workers
      pendingWorkerHours = [];
      if(crewData.suggested_workers && crewData.suggested_workers.length > 0) {
        crewData.suggested_workers.slice(0, 5).forEach(function(w) {
          pendingWorkerHours.push({
            worker_id: w.id,
            worker_name: w.full_name,
            hours_worked: 8 // Default to 8 hours
          });
        });
      }
      renderWorkerHoursList();
    }
  } catch(e) { console.error('Failed to load crew', e); }
}

function toggleNote(btn, note) {
  btn.classList.toggle('selected');
  var idx = selectedNotes.indexOf(note);
  if(idx >= 0) {
    selectedNotes.splice(idx, 1);
  } else {
    selectedNotes.push(note);
  }
}

function renderWorkerHoursList() {
  var container = document.getElementById('worker-hours-list');
  if(pendingWorkerHours.length === 0) {
    container.innerHTML = '<p style="color:#94a3b8;font-size:14px;text-align:center;padding:12px;">No workers added yet</p>';
    return;
  }

  var totalHours = pendingWorkerHours.reduce(function(sum, wh) { return sum + parseFloat(wh.hours_worked || 0); }, 0);

  var html = '<div style="font-size:12px;color:#64748b;margin-bottom:8px;">Total: '+totalHours.toFixed(1)+' hours</div>';
  pendingWorkerHours.forEach(function(wh, idx) {
    html += `
      <div class="worker-row">
        <span class="worker-name">${wh.worker_name}</span>
        <input type="number" class="worker-hours-input" value="${wh.hours_worked}" step="0.5" min="0" max="24" inputmode="decimal" onchange="updateWorkerHours(${idx}, this.value)">
        <button type="button" onclick="removeWorkerHours(${idx})" style="background:#ef4444;color:white;border:none;border-radius:8px;padding:8px 12px;cursor:pointer;min-width:44px;min-height:44px;">‚úï</button>
      </div>
    `;
  });
  container.innerHTML = html;
}

function updateWorkerHours(idx, hours) {
  var parsedHours = parseFloat(hours);

  // Validate hours
  if (isNaN(parsedHours) || parsedHours < 0) {
    parsedHours = 0;
  } else if (parsedHours > 24) {
    parsedHours = 24;
    showToast('Hours cannot exceed 24', 'warning');
  }

  pendingWorkerHours[idx].hours_worked = parsedHours;
  renderWorkerHoursList();
}

function removeWorkerHours(idx) {
  var workerName = pendingWorkerHours[idx].worker_name;
  pendingWorkerHours.splice(idx, 1);
  renderWorkerHoursList();
  showToast(workerName + ' removed', 'info');
}

function openAddWorkerHoursModal() {
  // Filter out workers already added
  var addedWorkerIds = pendingWorkerHours.map(function(wh) { return wh.worker_id; });
  var availableWorkers = workers.filter(function(w) { return addedWorkerIds.indexOf(w.id) === -1; });

  if(availableWorkers.length === 0) {
    showToast('All workers have been added', 'info');
    return;
  }

  var workerOpts = availableWorkers.map(function(w) {
    return '<div onclick="addWorkerHours('+w.id+', \''+w.full_name.replace(/'/g, "\\'")+'\')" style="padding:14px 16px;cursor:pointer;border-bottom:1px solid #eee;font-size:16px;min-height:52px;display:flex;align-items:center;" onmouseover="this.style.background=\'#f3f4f6\'" onmouseout="this.style.background=\'white\'">'+w.full_name+'</div>';
  }).join('');

  var modal = document.createElement('div');
  modal.id = 'add-worker-modal';
  modal.className = 'modal';
  modal.style.display = 'flex';
  modal.innerHTML = `
    <div class="modal-content" style="max-width:400px;">
      <div class="modal-header">
        <h2>Add Worker</h2>
        <button onclick="document.getElementById('add-worker-modal').remove()" class="icon-btn">‚úï</button>
      </div>
      <div class="modal-body" style="max-height:60vh;overflow-y:auto;padding:0;">
        ${workerOpts}
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

function addWorkerHours(workerId, workerName) {
  pendingWorkerHours.push({
    worker_id: workerId,
    worker_name: workerName,
    hours_worked: 8
  });
  document.getElementById('add-worker-modal').remove();
  renderWorkerHoursList();
}

function toggleItemDropdown() {
  var dropdown = document.getElementById('item-dropdown');
  dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
  if(dropdown.style.display === 'block') {
    document.getElementById('item-search').focus();
    renderItemDropdown();
  }
}

function filterItemsList() {
  renderItemDropdown();
}

function renderItemDropdown() {
  var search = (document.getElementById('item-search').value || '').toLowerCase();
  var filtered = items.filter(function(item) {
    return item.name.toLowerCase().includes(search);
  }).slice(0, 20);

  var html = '';
  filtered.forEach(function(item) {
    html += '<div onclick="selectWorkItem('+item.id+')" style="padding:14px 16px;cursor:pointer;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;min-height:52px;" onmouseover="this.style.background=\'#f3f4f6\'" onmouseout="this.style.background=\'white\'"><span style="font-size:15px;">'+item.name+'</span><span style="color:#64748b;font-size:13px;">'+item.unit_of_measure+'</span></div>';
  });

  if(filtered.length === 0) {
    html = '<div style="padding:16px;color:#64748b;text-align:center;">No items found</div>';
  }

  document.getElementById('item-dropdown').innerHTML = html;
}

function selectWorkItem(itemId) {
  var item = items.find(function(i) { return i.id === itemId; });
  if(!item) return;

  var qty = prompt('Enter quantity for "' + item.name + '" (' + item.unit_of_measure + '):');
  if(!qty || isNaN(parseFloat(qty))) return;

  pendingWorkItems.push({
    item_id: item.id,
    item_name: item.name,
    unit_of_measure: item.unit_of_measure,
    quantity: parseFloat(qty)
  });

  document.getElementById('item-dropdown').style.display = 'none';
  document.getElementById('item-search').value = '';
  renderPendingItems();
}

function renderPendingItems() {
  var html = '';
  pendingWorkItems.forEach(function(item, index) {
    html += '<div style="display:flex;justify-content:space-between;align-items:center;background:#dbeafe;padding:10px 14px;border-radius:10px;margin-bottom:8px;"><span style="font-size:14px;color:#1e40af;"><strong>'+item.quantity+'</strong> '+item.unit_of_measure+' - '+item.item_name+'</span><button type="button" onclick="removePendingItem('+index+')" style="background:#ef4444;color:white;border:none;border-radius:6px;padding:6px 10px;cursor:pointer;font-size:14px;min-width:36px;min-height:36px;">‚úï</button></div>';
  });
  document.getElementById('pending-items-list').innerHTML = html;
}

function removePendingItem(index) {
  pendingWorkItems.splice(index, 1);
  renderPendingItems();
}

function handlePhotoSelect(event) {
  var files = event.target.files;
  for(var i = 0; i < files.length; i++) {
    var file = files[i];
    if(!file.type.startsWith('image/')) continue;
    pendingPhotos.push(file);

    var reader = new FileReader();
    reader.onload = (function(index) {
      return function(e) {
        var preview = document.getElementById('photo-preview');
        var thumb = document.createElement('div');
        thumb.className = 'photo-thumb';
        thumb.innerHTML = '<img src="'+e.target.result+'"><button class="remove-photo" onclick="removePhoto('+index+')">‚úï</button>';
        preview.appendChild(thumb);
      };
    })(pendingPhotos.length - 1);
    reader.readAsDataURL(file);
  }
}

function removePhoto(index) {
  pendingPhotos.splice(index, 1);
  renderPhotoPreview();
}

function renderPhotoPreview() {
  var preview = document.getElementById('photo-preview');
  preview.innerHTML = '';
  pendingPhotos.forEach(function(file, index) {
    var reader = new FileReader();
    reader.onload = function(e) {
      var thumb = document.createElement('div');
      thumb.className = 'photo-thumb';
      thumb.innerHTML = '<img src="'+e.target.result+'"><button class="remove-photo" onclick="removePhoto('+index+')">‚úï</button>';
      preview.appendChild(thumb);
    };
    reader.readAsDataURL(file);
  });
}

async function saveDailyRecord() {
  // Prevent double submission
  if (isSaving) return;

  // Validate form
  if (!validateDailyRecordForm()) {
    return;
  }

  var jobId = document.getElementById('record-job').value;
  var recordDate = document.getElementById('record-date').value;
  var yardsInput = document.getElementById('record-yards').value;
  var additionalNotes = document.getElementById('record-notes').value.trim();

  // Combine selected notes with additional notes
  var allNotes = selectedNotes.slice();
  if(additionalNotes) allNotes.push(additionalNotes);
  var notes = allNotes.join('. ');

  // Build work items array
  var workItems = pendingWorkItems.map(function(item) {
    return { item_id: item.item_id, quantity: item.quantity };
  });

  // Build worker hours array
  var workerHours = pendingWorkerHours.filter(function(wh) {
    return wh.hours_worked > 0;
  }).map(function(wh) {
    return { worker_id: wh.worker_id, hours_worked: wh.hours_worked };
  });

  var data = {
    job_id: jobId,
    foreman_id: null,
    record_date: recordDate,
    notes: notes,
    work_items: workItems,
    worker_hours: workerHours,
    yards_poured: parseFloat(yardsInput) || 0,
    weather_data: currentWeather
  };

  // Get the save button and set loading state
  var saveBtn = document.querySelector('#daily-modal .btn-success');
  isSaving = true;
  setButtonLoading(saveBtn, true);

  try {
    // Save the record
    var record = await apiRequest(API+'/daily-records', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });

    // Upload photos if any
    if(pendingPhotos.length > 0) {
      try {
        var formData = new FormData();
        pendingPhotos.forEach(function(file) {
          formData.append('photos', file);
        });

        await fetch(API_BASE+'/daily-records/'+record.id+'/photos', {
          method: 'POST',
          body: formData
        });
      } catch(photoError) {
        console.error('Photo upload error:', photoError);
        showToast('Record saved but some photos failed to upload', 'warning');
      }
    }

    // Success!
    document.getElementById('daily-modal').remove();
    await loadAllData();
    showView('today');

    // Build success message
    var successParts = [];
    if (yardsInput && parseFloat(yardsInput) > 0) successParts.push(yardsInput + ' yards');
    if (workerHours.length > 0) {
      var totalHours = workerHours.reduce(function(sum, wh) { return sum + wh.hours_worked; }, 0);
      successParts.push(totalHours + ' worker hours');
    }
    if (pendingPhotos.length > 0) successParts.push(pendingPhotos.length + ' photo(s)');

    var successMsg = 'Daily record saved';
    if (successParts.length > 0) {
      successMsg += ': ' + successParts.join(', ');
    }
    showToast(successMsg, 'success');

  } catch(error) {
    console.error('Save error:', error);
    showToast(error.message || 'Failed to save record. Please try again.', 'error');
  } finally {
    isSaving = false;
    if (saveBtn) setButtonLoading(saveBtn, false);
  }
}

// Add photos to existing record
function openAddPhotosModal(recordId) {
  pendingPhotos = [];
  var modal = document.createElement('div'); modal.id='add-photos-modal'; modal.className='modal'; modal.style.display='flex';
  modal.innerHTML = '<div class="modal-content"><div class="modal-header"><h2>Add Photos</h2><button onclick="document.getElementById(\'add-photos-modal\').remove()" class="icon-btn">‚úï</button></div><div class="modal-body"><div class="photo-upload-area" id="add-photo-upload-area" onclick="document.getElementById(\'add-photo-input\').click()"><input type="file" id="add-photo-input" multiple accept="image/*" capture="environment" style="display:none;" onchange="handleAddPhotoSelect(event)"><div class="upload-icon">üì∑</div><p>Tap to take photo or select from gallery</p></div><div class="photo-preview" id="add-photo-preview"></div></div><div class="modal-footer"><button onclick="document.getElementById(\'add-photos-modal\').remove()" class="btn btn-secondary">Cancel</button><button onclick="uploadPhotosToRecord('+recordId+')" class="btn btn-primary">Upload</button></div></div>';
  document.body.appendChild(modal);

  var uploadArea = document.getElementById('add-photo-upload-area');
  uploadArea.addEventListener('dragover', function(e) { e.preventDefault(); this.classList.add('dragover'); });
  uploadArea.addEventListener('dragleave', function(e) { e.preventDefault(); this.classList.remove('dragover'); });
  uploadArea.addEventListener('drop', function(e) { e.preventDefault(); this.classList.remove('dragover'); handleAddPhotoSelect({target:{files:e.dataTransfer.files}}); });
}

function handleAddPhotoSelect(event) {
  var files = event.target.files;
  for(var i = 0; i < files.length; i++) {
    var file = files[i];
    if(!file.type.startsWith('image/')) continue;
    pendingPhotos.push(file);

    var reader = new FileReader();
    reader.onload = function(e) {
      var preview = document.getElementById('add-photo-preview');
      var thumb = document.createElement('div');
      thumb.className = 'photo-thumb';
      thumb.innerHTML = '<img src="'+e.target.result+'">';
      preview.appendChild(thumb);
    };
    reader.readAsDataURL(file);
  }
}

async function uploadPhotosToRecord(recordId) {
  if(pendingPhotos.length === 0) {
    showToast('No photos selected', 'warning');
    return;
  }

  // Validate file sizes (max 10MB each)
  var oversizedFiles = pendingPhotos.filter(function(f) { return f.size > 10 * 1024 * 1024; });
  if (oversizedFiles.length > 0) {
    showToast('Some files exceed 10MB limit', 'error');
    return;
  }

  var uploadBtn = document.querySelector('#add-photos-modal .btn-primary');
  setButtonLoading(uploadBtn, true);

  var formData = new FormData();
  pendingPhotos.forEach(function(file) {
    formData.append('photos', file);
  });

  try {
    var res = await fetch(API_BASE+'/daily-records/'+recordId+'/photos', {
      method: 'POST',
      body: formData
    });

    if(res.ok) {
      document.getElementById('add-photos-modal').remove();
      await loadAllData();
      showView('today');
      showToast(pendingPhotos.length + ' photo(s) uploaded successfully', 'success');
    } else {
      var err = await res.json();
      throw new Error(err.error || 'Upload failed');
    }
  } catch(e) {
    console.error('Upload error:', e);
    showToast(e.message || 'Error uploading photos. Please try again.', 'error');
  } finally {
    if (uploadBtn) setButtonLoading(uploadBtn, false);
  }
}

// ========== REAL-TIME VALIDATION ==========
function setupFormValidation() {
  // This is called after the modal is created
  var jobSelect = document.getElementById('record-job');
  var dateInput = document.getElementById('record-date');
  var yardsInput = document.getElementById('record-yards');

  if (jobSelect) {
    jobSelect.addEventListener('change', function() {
      if (this.value) {
        clearFieldError('record-job');
        markFieldSuccess('record-job');
      }
    });
  }

  if (dateInput) {
    dateInput.addEventListener('change', function() {
      var error = validateDate(this.value, 'Date');
      if (error) {
        showFieldError('record-date', error);
      } else {
        clearFieldError('record-date');
        markFieldSuccess('record-date');
      }
    });
  }

  if (yardsInput) {
    yardsInput.addEventListener('input', function() {
      var error = validateNumber(this.value, 'Yards', 0, 9999);
      if (error) {
        showFieldError('record-yards', error);
      } else {
        clearFieldError('record-yards');
      }
    });
  }
}
</script>
</body>
</html>
