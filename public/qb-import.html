<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QB Import - Foreman System</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f3f4f6; }
    .app-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .app-header h1 { font-size: 18px; color: #333; }
    .back-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #2563eb; text-decoration: none; }
    .main-content { padding: 20px; max-width: 1200px; margin: 0 auto; }
    .section { background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .section h2 { font-size: 18px; margin-bottom: 20px; color: #333; display: flex; align-items: center; gap: 10px; }
    .tabs { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 2px solid #e5e7eb; padding-bottom: 15px; }
    .tab-btn { padding: 12px 24px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer; font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }
    .tab-btn:hover { border-color: #2563eb; background: #f0f7ff; }
    .tab-btn.active { border-color: #2563eb; background: #2563eb; color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .upload-area { border: 3px dashed #ddd; border-radius: 12px; padding: 50px 20px; text-align: center; cursor: pointer; transition: all 0.3s; }
    .upload-area:hover, .upload-area.dragover { border-color: #2563eb; background: #f0f7ff; }
    .upload-area h3 { font-size: 20px; margin-bottom: 10px; color: #333; }
    .upload-area p { color: #666; margin-bottom: 15px; }
    .upload-icon { font-size: 48px; margin-bottom: 15px; }
    .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; font-weight: 600; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-secondary { background: #e5e7eb; color: #333; }
    .btn-success { background: #22c55e; color: white; }
    .btn-warning { background: #f97316; color: white; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .type-selector { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .type-btn { padding: 12px 20px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }
    .type-btn:hover { border-color: #2563eb; }
    .type-btn.active { border-color: #2563eb; background: #dbeafe; }
    .type-btn .icon { font-size: 20px; }
    .mapping-section { margin-top: 20px; }
    .mapping-row { display: flex; gap: 15px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; }
    .mapping-row label { min-width: 150px; font-weight: 600; color: #333; }
    .mapping-row select { flex: 1; min-width: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
    .preview-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
    .preview-table th, .preview-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #eee; }
    .preview-table th { background: #f9fafb; font-weight: 600; color: #666; text-transform: uppercase; font-size: 11px; position: sticky; top: 0; }
    .preview-table tr:hover { background: #f9fafb; }
    .preview-container { max-height: 400px; overflow: auto; border: 1px solid #eee; border-radius: 8px; }
    .stats-row { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
    .stat-card { background: #f9fafb; border-radius: 8px; padding: 15px 20px; flex: 1; min-width: 150px; }
    .stat-card .label { font-size: 12px; color: #666; text-transform: uppercase; }
    .stat-card .value { font-size: 28px; font-weight: bold; color: #333; margin-top: 5px; }
    .stat-card.success .value { color: #22c55e; }
    .stat-card.warning .value { color: #f97316; }
    .stat-card.error .value { color: #ef4444; }
    .progress-bar { height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin: 15px 0; }
    .progress-fill { height: 100%; background: #2563eb; transition: width 0.3s; }
    .result-message { padding: 15px; border-radius: 8px; margin-top: 15px; }
    .result-message.success { background: #dcfce7; color: #166534; }
    .result-message.error { background: #fee2e2; color: #991b1b; }
    .error-list { max-height: 200px; overflow: auto; font-size: 13px; margin-top: 10px; }
    .error-item { padding: 8px; background: #fff; border-radius: 4px; margin-bottom: 5px; }
    .hidden { display: none; }
    .step-indicator { display: flex; gap: 10px; margin-bottom: 25px; }
    .step { display: flex; align-items: center; gap: 8px; padding: 10px 15px; border-radius: 8px; background: #f3f4f6; color: #666; }
    .step.active { background: #2563eb; color: white; }
    .step.completed { background: #22c55e; color: white; }
    .step-number { width: 24px; height: 24px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; }
    .actions { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
    /* PDF specific styles */
    .header-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; padding: 20px; background: #f9fafb; border-radius: 8px; }
    .header-item { }
    .header-item .label { font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 4px; }
    .header-item .value { font-size: 16px; font-weight: 600; color: #333; }
    .header-item .value.highlight { color: #2563eb; }
    .line-items-table { width: 100%; border-collapse: collapse; font-size: 14px; }
    .line-items-table th, .line-items-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
    .line-items-table th { background: #f9fafb; font-weight: 600; color: #666; text-transform: uppercase; font-size: 11px; }
    .line-items-table tr:hover { background: #f9fafb; }
    .line-items-table .number { text-align: right; font-family: monospace; }
    .line-items-table tfoot td { font-weight: 600; background: #f3f4f6; }
    .input-group { margin-bottom: 20px; }
    .input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
    .input-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
    .import-options { display: flex; gap: 15px; margin-bottom: 20px; }
    .import-option { flex: 1; padding: 20px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.2s; }
    .import-option:hover { border-color: #2563eb; }
    .import-option.selected { border-color: #2563eb; background: #dbeafe; }
    .import-option .icon { font-size: 32px; margin-bottom: 10px; }
    .import-option .title { font-weight: 600; margin-bottom: 5px; }
    .import-option .desc { font-size: 12px; color: #666; }
    .matched-job { background: #dcfce7; padding: 12px 15px; border-radius: 8px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    .matched-job .icon { font-size: 20px; }
    .matched-job .text { color: #166534; }
    .job-action-box { padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
    .job-action-box.create { background: #dbeafe; border: 2px solid #2563eb; }
    .job-action-box.match { background: #dcfce7; border: 2px solid #22c55e; }
    .job-action-box .icon { font-size: 28px; }
    .job-action-box .text { flex: 1; }
    .job-action-box .title { font-weight: 600; font-size: 16px; }
    .job-action-box.create .title { color: #1e40af; }
    .job-action-box.match .title { color: #166534; }
    .job-action-box .subtitle { font-size: 13px; color: #666; margin-top: 2px; }
    .toggle-link { color: #2563eb; font-size: 13px; cursor: pointer; text-decoration: underline; }
  </style>
</head>
<body>
  <header class="app-header">
    <a href="/index.html" class="back-btn">‚Üê Back</a>
    <h1>QB Import</h1>
    <div style="width: 50px;"></div>
  </header>

  <div class="main-content">
    <!-- Main Tabs -->
    <div class="tabs">
      <button class="tab-btn" onclick="showMainTab('paste')">
        <span style="font-size:20px;">üìã</span>
        Paste from QB
      </button>
      <button class="tab-btn" onclick="showMainTab('pdf')">
        <span style="font-size:20px;">üìÑ</span>
        PDF Import
      </button>
      <button class="tab-btn active" onclick="showMainTab('csv')">
        <span style="font-size:20px;">üìä</span>
        CSV / Excel
      </button>
    </div>

    <!-- CSV/Excel Tab Content -->
    <div id="csv-tab" class="tab-content active">
      <!-- Step Indicator -->
      <div class="step-indicator">
        <div class="step active" id="step1-indicator">
          <span class="step-number">1</span>
          <span>Upload File</span>
        </div>
        <div class="step" id="step2-indicator">
          <span class="step-number">2</span>
          <span>Map Columns</span>
        </div>
        <div class="step" id="step3-indicator">
          <span class="step-number">3</span>
          <span>Import</span>
        </div>
      </div>

      <!-- Step 1: Upload -->
      <div id="step1" class="section">
        <h2><span style="font-size:24px;">üì§</span> Upload QuickBooks Export</h2>

        <div class="type-selector">
          <button class="type-btn active" data-type="auto" onclick="selectType('auto')">
            <span class="icon">üîç</span>
            <span>Auto-Detect</span>
          </button>
          <button class="type-btn" data-type="jobs" onclick="selectType('jobs')">
            <span class="icon">üìã</span>
            <span>Jobs/Customers</span>
          </button>
          <button class="type-btn" data-type="costs" onclick="selectType('costs')">
            <span class="icon">üí∞</span>
            <span>Bills/Costs</span>
          </button>
          <button class="type-btn" data-type="time" onclick="selectType('time')">
            <span class="icon">‚è±Ô∏è</span>
            <span>Time Entries</span>
          </button>
        </div>

        <div class="upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
          <input type="file" id="file-input" accept=".csv,.xlsx,.xls" style="display:none" onchange="handleFileSelect(event)">
          <div class="upload-icon">üìÅ</div>
          <h3>Drop your file here</h3>
          <p>or click to browse</p>
          <p style="font-size:12px;color:#999;">Supports CSV, XLS, XLSX</p>
        </div>
      </div>

      <!-- Step 2: Preview & Map -->
      <div id="step2" class="section hidden">
        <h2><span style="font-size:24px;">üóÇÔ∏è</span> Map Columns</h2>

        <div class="stats-row">
          <div class="stat-card">
            <div class="label">File</div>
            <div class="value" id="file-name" style="font-size:14px;word-break:break-all;">-</div>
          </div>
          <div class="stat-card">
            <div class="label">Rows Found</div>
            <div class="value" id="row-count">0</div>
          </div>
          <div class="stat-card">
            <div class="label">Type Detected</div>
            <div class="value" id="detected-type" style="font-size:16px;">-</div>
          </div>
        </div>

        <div id="mapping-jobs" class="mapping-section">
          <h3 style="margin-bottom:15px;">Column Mapping (Jobs)</h3>
          <div class="mapping-row">
            <label>Job Number:</label>
            <select id="map-job-number"><option value="">-- Select Column --</option></select>
          </div>
          <div class="mapping-row">
            <label>Job Name:</label>
            <select id="map-job-name"><option value="">-- Select Column --</option></select>
          </div>
          <div class="mapping-row">
            <label>Location/Address:</label>
            <select id="map-location"><option value="">-- Select Column --</option></select>
          </div>
          <div class="mapping-row">
            <label>Contractor:</label>
            <select id="map-contractor"><option value="">-- Select Column --</option></select>
          </div>
        </div>

        <div id="mapping-costs" class="mapping-section hidden">
          <h3 style="margin-bottom:15px;">Column Mapping (Costs)</h3>
          <div class="mapping-row">
            <label>Invoice/Bill #:</label>
            <select id="map-invoice-number"><option value="">-- Select Column --</option></select>
          </div>
          <div class="mapping-row">
            <label>Vendor:</label>
            <select id="map-vendor"><option value="">-- Select Column --</option></select>
          </div>
          <div class="mapping-row">
            <label>Date:</label>
            <select id="map-cost-date"><option value="">-- Select Column --</option></select>
          </div>
          <div class="mapping-row">
            <label>Amount:</label>
            <select id="map-amount"><option value="">-- Select Column --</option></select>
          </div>
          <div class="mapping-row">
            <label>Description:</label>
            <select id="map-description"><option value="">-- Select Column --</option></select>
          </div>
          <div class="mapping-row">
            <label>Job Reference:</label>
            <select id="map-cost-job"><option value="">-- Select Column --</option></select>
          </div>
        </div>

        <div id="mapping-time" class="mapping-section hidden">
          <h3 style="margin-bottom:15px;">Column Mapping (Time)</h3>
          <div class="mapping-row">
            <label>Employee/Worker:</label>
            <select id="map-worker"><option value="">-- Select Column --</option></select>
          </div>
          <div class="mapping-row">
            <label>Date:</label>
            <select id="map-time-date"><option value="">-- Select Column --</option></select>
          </div>
          <div class="mapping-row">
            <label>Hours:</label>
            <select id="map-hours"><option value="">-- Select Column --</option></select>
          </div>
          <div class="mapping-row">
            <label>Job Reference:</label>
            <select id="map-time-job"><option value="">-- Select Column --</option></select>
          </div>
          <div class="mapping-row">
            <label>Rate (optional):</label>
            <select id="map-rate"><option value="">-- Select Column --</option></select>
          </div>
        </div>

        <h3 style="margin:20px 0 15px;">Data Preview (first 10 rows)</h3>
        <div class="preview-container">
          <table class="preview-table" id="preview-table">
            <thead><tr></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="actions">
          <button class="btn btn-secondary" onclick="resetImport()">Cancel</button>
          <button class="btn btn-primary" onclick="goToStep3()">Continue to Import</button>
        </div>
      </div>

      <!-- Step 3: Execute Import -->
      <div id="step3" class="section hidden">
        <h2><span style="font-size:24px;">üöÄ</span> Execute Import</h2>

        <div class="stats-row">
          <div class="stat-card">
            <div class="label">Total Rows</div>
            <div class="value" id="total-rows">0</div>
          </div>
          <div class="stat-card success">
            <div class="label">Imported</div>
            <div class="value" id="imported-count">0</div>
          </div>
          <div class="stat-card warning">
            <div class="label">Skipped</div>
            <div class="value" id="skipped-count">0</div>
          </div>
          <div class="stat-card error">
            <div class="label">Errors</div>
            <div class="value" id="error-count">0</div>
          </div>
        </div>

        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill" style="width:0%"></div>
        </div>

        <div id="import-result"></div>

        <div class="actions">
          <button class="btn btn-secondary" onclick="resetImport()" id="cancel-btn">Cancel</button>
          <button class="btn btn-success" onclick="executeImport()" id="import-btn">Start Import</button>
          <button class="btn btn-primary hidden" onclick="resetImport()" id="done-btn">Import Another File</button>
        </div>
      </div>
    </div>

    <!-- Paste Tab Content -->
    <div id="paste-tab" class="tab-content">
      <!-- Paste Step 1: Enter Data -->
      <div id="paste-step1" class="section">
        <h2><span style="font-size:24px;">üìã</span> Paste from QuickBooks</h2>
        <p style="color:#666;margin-bottom:20px;">Copy line items directly from a QuickBooks proposal/estimate page and paste them below.</p>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
          <div class="input-group" style="margin-bottom:0;">
            <label>Job Name <span style="color:#e53e3e;">*</span></label>
            <input type="text" id="paste-job-name" placeholder="e.g., Redwood Square" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;">
          </div>
          <div class="input-group" style="margin-bottom:0;">
            <label>Proposal/Estimate Number</label>
            <input type="text" id="paste-proposal-num" placeholder="e.g., 1047" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;">
          </div>
        </div>

        <div class="input-group">
          <label>Paste Line Items from QuickBooks</label>
          <textarea id="paste-text" rows="12" placeholder="Copy and paste the line items table from QuickBooks here...

Example format:
4&quot; Flatwork    Concrete flatwork 4 inches thick    500    3.50    1,750.00
6&quot; Flatwork    Concrete flatwork 6 inches thick    200    4.25    850.00
Rebar    #4 rebar grid    1    450.00    450.00

The parser will try to detect: Product/Service, Description, Qty, Rate, Total" style="width:100%;padding:15px;border:1px solid #ddd;border-radius:8px;font-size:14px;font-family:monospace;resize:vertical;"></textarea>
        </div>

        <div style="background:#f0f7ff;border:1px solid #93c5fd;border-radius:8px;padding:15px;margin-bottom:20px;">
          <h4 style="margin:0 0 8px;color:#1e40af;font-size:14px;">Tips for copying from QuickBooks:</h4>
          <ul style="margin:0;padding-left:20px;color:#1e40af;font-size:13px;">
            <li>Select the entire line items table (Product/Service through Amount columns)</li>
            <li>Copy (Ctrl+C / Cmd+C) and paste here</li>
            <li>Works with tab-separated or space-separated data</li>
            <li>Header row will be auto-detected and skipped</li>
          </ul>
        </div>

        <div class="actions">
          <button class="btn btn-primary" onclick="parsePastedText()" style="font-size:16px;padding:15px 30px;">Parse Line Items</button>
        </div>
      </div>

      <!-- Paste Step 2: Review & Import -->
      <div id="paste-step2" class="section hidden">
        <h2><span style="font-size:24px;">üìã</span> Review Parsed Data</h2>

        <div id="paste-job-action" class="job-action-box"></div>

        <div class="header-info" id="paste-header-info"></div>

        <div class="input-group" id="paste-job-override-section" style="display:none;">
          <label>Or assign to existing job:</label>
          <select id="paste-job-select">
            <option value="">-- Auto-create new job --</option>
          </select>
        </div>

        <h3 style="margin-bottom:15px;">Parsed Line Items (<span id="paste-item-count">0</span> found)</h3>
        <div class="preview-container">
          <table class="line-items-table" id="paste-line-items">
            <thead>
              <tr>
                <th>Product/Service</th>
                <th>Description</th>
                <th class="number">Qty</th>
                <th class="number">Rate</th>
                <th class="number">Total</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <td colspan="4" style="text-align:right;"><strong>Proposal Total:</strong></td>
                <td class="number" id="paste-total" style="font-size:18px;color:#22c55e;">$0.00</td>
              </tr>
            </tfoot>
          </table>
        </div>

        <div class="import-summary" style="background:#f0f7ff;border:1px solid #2563eb;border-radius:8px;padding:15px;margin-top:20px;">
          <h4 style="margin:0 0 10px;color:#1e40af;">Import will:</h4>
          <ul style="margin:0;padding-left:20px;color:#1e40af;">
            <li id="paste-summary-job">Create new job or match existing</li>
            <li id="paste-summary-income">Set job income to proposal total</li>
            <li id="paste-summary-takeoffs">Save <span id="paste-summary-count">0</span> line items as takeoffs</li>
          </ul>
        </div>

        <div id="paste-import-result"></div>

        <div class="actions">
          <button class="btn btn-secondary" onclick="resetPasteImport()">Back</button>
          <button class="btn btn-success" onclick="executePasteImport()" id="paste-import-btn" style="font-size:16px;padding:15px 30px;">Import Proposal</button>
        </div>
      </div>

      <!-- Paste Step 3: Success -->
      <div id="paste-step3" class="section hidden">
        <div style="text-align:center;padding:40px;">
          <div style="font-size:64px;margin-bottom:20px;">‚úÖ</div>
          <h2 style="color:#166534;margin-bottom:15px;">Import Complete!</h2>
          <div id="paste-success-details" style="font-size:16px;color:#333;margin-bottom:30px;"></div>
          <div style="display:flex;gap:15px;justify-content:center;">
            <button class="btn btn-secondary" onclick="resetPasteImport()">Import Another</button>
            <button class="btn btn-primary" onclick="goToPasteJob()" id="go-to-paste-job-btn">View Job</button>
          </div>
        </div>
      </div>
    </div>

    <!-- PDF Tab Content -->
    <div id="pdf-tab" class="tab-content">
      <!-- PDF Step 1: Upload -->
      <div id="pdf-step1" class="section">
        <h2><span style="font-size:24px;">üìÑ</span> Upload QB Proposal/Estimate PDF</h2>

        <div class="upload-area" id="pdf-upload-area" onclick="document.getElementById('pdf-file-input').click()">
          <input type="file" id="pdf-file-input" accept=".pdf" style="display:none" onchange="handlePdfSelect(event)">
          <div class="upload-icon">üìÑ</div>
          <h3>Drop your PDF here</h3>
          <p>or click to browse</p>
          <p style="font-size:12px;color:#999;">QuickBooks Proposals, Estimates, or Invoices</p>
        </div>
      </div>

      <!-- PDF Step 2: Review & Import -->
      <div id="pdf-step2" class="section hidden">
        <h2><span style="font-size:24px;">üìã</span> Review Extracted Data</h2>

        <div id="pdf-job-action" class="job-action-box"></div>

        <div class="header-info" id="pdf-header-info">
          <!-- Header info will be populated -->
        </div>

        <div class="input-group" id="job-override-section" style="display:none;">
          <label>Or assign to existing job:</label>
          <select id="pdf-job-select">
            <option value="">-- Auto-create new job --</option>
          </select>
        </div>

        <h3 style="margin-bottom:15px;">Line Items (<span id="pdf-item-count">0</span> found) - Will be saved as Takeoffs</h3>
        <div class="preview-container">
          <table class="line-items-table" id="pdf-line-items">
            <thead>
              <tr>
                <th>Product/Service</th>
                <th>Description</th>
                <th class="number">Qty</th>
                <th class="number">Rate</th>
                <th class="number">Total</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <td colspan="4" style="text-align:right;"><strong>Proposal Total (will set Job Income):</strong></td>
                <td class="number" id="pdf-total" style="font-size:18px;color:#22c55e;">$0.00</td>
              </tr>
            </tfoot>
          </table>
        </div>

        <div class="import-summary" style="background:#f0f7ff;border:1px solid #2563eb;border-radius:8px;padding:15px;margin-top:20px;">
          <h4 style="margin:0 0 10px;color:#1e40af;">Import will:</h4>
          <ul style="margin:0;padding-left:20px;color:#1e40af;">
            <li id="summary-job">Create new job or match existing</li>
            <li id="summary-income">Set job income to proposal total</li>
            <li id="summary-takeoffs">Save <span id="summary-count">0</span> line items as takeoffs with quantities and prices</li>
          </ul>
        </div>

        <div id="pdf-import-result"></div>

        <div class="actions">
          <button class="btn btn-secondary" onclick="resetPdfImport()">Cancel</button>
          <button class="btn btn-success" onclick="executePdfImport()" id="pdf-import-btn" style="font-size:16px;padding:15px 30px;">Import Proposal</button>
        </div>
      </div>

      <!-- PDF Step 3: Success -->
      <div id="pdf-step3" class="section hidden">
        <div style="text-align:center;padding:40px;">
          <div style="font-size:64px;margin-bottom:20px;">‚úÖ</div>
          <h2 style="color:#166534;margin-bottom:15px;">Import Complete!</h2>
          <div id="pdf-success-details" style="font-size:16px;color:#333;margin-bottom:30px;"></div>
          <div style="display:flex;gap:15px;justify-content:center;">
            <button class="btn btn-secondary" onclick="resetPdfImport()">Import Another</button>
            <button class="btn btn-primary" onclick="goToJob()" id="go-to-job-btn">View Job</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    var API_BASE = '/api';
    var currentType = 'auto';
    var importData = null;
    var headers = [];
    var pdfData = null;
    var pdfImportAs = 'costs';

    // Tab switching
    function showMainTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(function(btn) {
        btn.classList.remove('active');
      });
      document.querySelectorAll('.tab-content').forEach(function(content) {
        content.classList.remove('active');
      });

      event.target.closest('.tab-btn').classList.add('active');
      document.getElementById(tab + '-tab').classList.add('active');
    }

    // ============ CSV/Excel Import Functions ============

    // Setup drag and drop
    var uploadArea = document.getElementById('upload-area');
    uploadArea.addEventListener('dragover', function(e) { e.preventDefault(); this.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', function(e) { e.preventDefault(); this.classList.remove('dragover'); });
    uploadArea.addEventListener('drop', function(e) {
      e.preventDefault();
      this.classList.remove('dragover');
      var files = e.dataTransfer.files;
      if (files.length > 0) handleFile(files[0]);
    });

    function selectType(type) {
      currentType = type;
      document.querySelectorAll('.type-btn').forEach(function(btn) {
        btn.classList.toggle('active', btn.dataset.type === type);
      });
    }

    function handleFileSelect(event) {
      var file = event.target.files[0];
      if (file) handleFile(file);
    }

    async function handleFile(file) {
      var formData = new FormData();
      formData.append('file', file);
      formData.append('type', currentType);

      try {
        var res = await fetch(API_BASE + '/qb-import/preview', {
          method: 'POST',
          body: formData
        });

        if (!res.ok) {
          var err = await res.json();
          alert('Error: ' + (err.error || 'Failed to parse file'));
          return;
        }

        importData = await res.json();

        if (importData.error) {
          alert('Error: ' + importData.error);
          return;
        }

        headers = importData.headers;
        currentType = importData.detected_type;

        document.getElementById('file-name').textContent = importData.file_name;
        document.getElementById('row-count').textContent = importData.row_count;
        document.getElementById('detected-type').textContent = currentType.charAt(0).toUpperCase() + currentType.slice(1);

        populateMappingSelects();
        renderPreviewTable();

        document.getElementById('mapping-jobs').classList.toggle('hidden', currentType !== 'jobs');
        document.getElementById('mapping-costs').classList.toggle('hidden', currentType !== 'costs');
        document.getElementById('mapping-time').classList.toggle('hidden', currentType !== 'time');

        goToStep(2);
      } catch (e) {
        console.error('Upload error:', e);
        alert('Failed to upload file: ' + e.message);
      }
    }

    function populateMappingSelects() {
      var selects = document.querySelectorAll('.mapping-row select');
      selects.forEach(function(select) {
        select.innerHTML = '<option value="">-- Select Column --</option>';
        headers.forEach(function(h) {
          var opt = document.createElement('option');
          opt.value = h;
          opt.textContent = h;
          select.appendChild(opt);
        });
        // Auto-match
        var selectId = select.id.replace('map-', '');
        headers.forEach(function(h) {
          var hl = h.toLowerCase();
          if (selectId === 'job-number' && (hl.includes('job') && hl.includes('number') || hl === 'job #')) select.value = h;
          if (selectId === 'job-name' && (hl.includes('job') && hl.includes('name') || hl.includes('customer') || hl.includes('project'))) select.value = h;
          if (selectId === 'location' && (hl.includes('address') || hl.includes('location'))) select.value = h;
          if (selectId === 'contractor' && (hl.includes('contractor') || hl.includes('builder'))) select.value = h;
          if (selectId === 'invoice-number' && (hl.includes('invoice') || hl.includes('bill'))) select.value = h;
          if (selectId === 'vendor' && (hl.includes('vendor') || hl.includes('supplier'))) select.value = h;
          if (selectId === 'cost-date' && hl.includes('date')) select.value = h;
          if (selectId === 'amount' && (hl.includes('amount') || hl.includes('total'))) select.value = h;
          if (selectId === 'description' && (hl.includes('description') || hl.includes('memo'))) select.value = h;
          if (selectId === 'cost-job' && (hl.includes('job') || hl.includes('customer'))) select.value = h;
          if (selectId === 'worker' && (hl.includes('employee') || hl.includes('worker'))) select.value = h;
          if (selectId === 'time-date' && hl.includes('date')) select.value = h;
          if (selectId === 'hours' && (hl.includes('hour') || hl.includes('time'))) select.value = h;
          if (selectId === 'time-job' && (hl.includes('job') || hl.includes('customer'))) select.value = h;
          if (selectId === 'rate' && hl.includes('rate')) select.value = h;
        });
      });
    }

    function renderPreviewTable() {
      var thead = document.querySelector('#preview-table thead tr');
      var tbody = document.querySelector('#preview-table tbody');
      thead.innerHTML = '<th>#</th>' + headers.map(function(h) { return '<th>' + escapeHtml(h) + '</th>'; }).join('');
      var html = '';
      importData.preview.forEach(function(row, i) {
        html += '<tr><td>' + (i + 1) + '</td>';
        headers.forEach(function(h) { html += '<td>' + escapeHtml(String(row[h] || '')) + '</td>'; });
        html += '</tr>';
      });
      tbody.innerHTML = html;
    }

    function escapeHtml(str) {
      var div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function goToStep(step) {
      document.getElementById('step1').classList.toggle('hidden', step !== 1);
      document.getElementById('step2').classList.toggle('hidden', step !== 2);
      document.getElementById('step3').classList.toggle('hidden', step !== 3);

      document.getElementById('step1-indicator').classList.remove('active', 'completed');
      document.getElementById('step2-indicator').classList.remove('active', 'completed');
      document.getElementById('step3-indicator').classList.remove('active', 'completed');

      if (step === 1) document.getElementById('step1-indicator').classList.add('active');
      else if (step === 2) { document.getElementById('step1-indicator').classList.add('completed'); document.getElementById('step2-indicator').classList.add('active'); }
      else if (step === 3) { document.getElementById('step1-indicator').classList.add('completed'); document.getElementById('step2-indicator').classList.add('completed'); document.getElementById('step3-indicator').classList.add('active'); }
    }

    function goToStep3() {
      document.getElementById('total-rows').textContent = importData.row_count;
      document.getElementById('imported-count').textContent = '0';
      document.getElementById('skipped-count').textContent = '0';
      document.getElementById('error-count').textContent = '0';
      document.getElementById('progress-fill').style.width = '0%';
      document.getElementById('import-result').innerHTML = '';
      document.getElementById('import-btn').classList.remove('hidden');
      document.getElementById('cancel-btn').classList.remove('hidden');
      document.getElementById('done-btn').classList.add('hidden');
      goToStep(3);
    }

    function getMappings() {
      var mappings = {};
      if (currentType === 'jobs') {
        mappings.job_number = document.getElementById('map-job-number').value;
        mappings.job_name = document.getElementById('map-job-name').value;
        mappings.location = document.getElementById('map-location').value;
        mappings.contractor = document.getElementById('map-contractor').value;
      } else if (currentType === 'costs') {
        mappings.invoice_number = document.getElementById('map-invoice-number').value;
        mappings.vendor = document.getElementById('map-vendor').value;
        mappings.date = document.getElementById('map-cost-date').value;
        mappings.amount = document.getElementById('map-amount').value;
        mappings.description = document.getElementById('map-description').value;
        mappings.job = document.getElementById('map-cost-job').value;
      } else if (currentType === 'time') {
        mappings.worker = document.getElementById('map-worker').value;
        mappings.date = document.getElementById('map-time-date').value;
        mappings.hours = document.getElementById('map-hours').value;
        mappings.job = document.getElementById('map-time-job').value;
        mappings.rate = document.getElementById('map-rate').value;
      }
      return mappings;
    }

    async function executeImport() {
      var mappings = getMappings();
      document.getElementById('import-btn').disabled = true;
      document.getElementById('cancel-btn').disabled = true;
      document.getElementById('progress-fill').style.width = '50%';

      try {
        var res = await fetch(API_BASE + '/qb-import/execute', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type: currentType, mappings: mappings, data: importData.all_data })
        });

        var result = await res.json();
        document.getElementById('progress-fill').style.width = '100%';
        document.getElementById('imported-count').textContent = result.imported || 0;
        document.getElementById('skipped-count').textContent = result.skipped || 0;
        document.getElementById('error-count').textContent = (result.errors || []).length;

        var resultDiv = document.getElementById('import-result');
        if (result.error) {
          resultDiv.innerHTML = '<div class="result-message error"><strong>Import Failed:</strong> ' + result.error + '</div>';
        } else {
          var html = '<div class="result-message success"><strong>Import Complete!</strong> Imported ' + result.imported + ' records.';
          if (result.skipped > 0) html += ' Skipped ' + result.skipped + ' rows.';
          html += '</div>';
          if (result.errors && result.errors.length > 0) {
            html += '<div style="margin-top:15px;"><strong>Errors:</strong><div class="error-list">';
            result.errors.forEach(function(e) { html += '<div class="error-item">Row ' + e.row + ': ' + e.error + '</div>'; });
            html += '</div></div>';
          }
          resultDiv.innerHTML = html;
        }

        document.getElementById('import-btn').classList.add('hidden');
        document.getElementById('cancel-btn').classList.add('hidden');
        document.getElementById('done-btn').classList.remove('hidden');
      } catch (e) {
        document.getElementById('import-result').innerHTML = '<div class="result-message error"><strong>Import Failed:</strong> ' + e.message + '</div>';
        document.getElementById('import-btn').disabled = false;
        document.getElementById('cancel-btn').disabled = false;
      }
    }

    function resetImport() {
      importData = null;
      headers = [];
      currentType = 'auto';
      document.getElementById('file-input').value = '';
      selectType('auto');
      goToStep(1);
    }

    // ============ PDF Import Functions ============

    var pdfUploadArea = document.getElementById('pdf-upload-area');
    var importedJobId = null;

    pdfUploadArea.addEventListener('dragover', function(e) { e.preventDefault(); this.classList.add('dragover'); });
    pdfUploadArea.addEventListener('dragleave', function(e) { e.preventDefault(); this.classList.remove('dragover'); });
    pdfUploadArea.addEventListener('drop', function(e) {
      e.preventDefault();
      this.classList.remove('dragover');
      var files = e.dataTransfer.files;
      if (files.length > 0) handlePdfFile(files[0]);
    });

    function handlePdfSelect(event) {
      var file = event.target.files[0];
      if (file) handlePdfFile(file);
    }

    async function handlePdfFile(file) {
      if (!file.name.toLowerCase().endsWith('.pdf')) {
        alert('Please select a PDF file');
        return;
      }

      var formData = new FormData();
      formData.append('file', file);

      try {
        var res = await fetch(API_BASE + '/qb-import/parse-pdf', {
          method: 'POST',
          body: formData
        });

        if (!res.ok) {
          var err = await res.json();
          alert('Error: ' + (err.error || 'Failed to parse PDF'));
          return;
        }

        pdfData = await res.json();

        if (pdfData.error) {
          alert('Error: ' + pdfData.error);
          return;
        }

        renderPdfResults();
      } catch (e) {
        console.error('PDF parse error:', e);
        alert('Failed to parse PDF: ' + e.message);
      }
    }

    function renderPdfResults() {
      var h = pdfData.header;
      var jobName = h.job_name || h.customer || '';
      var proposalNum = h.proposal_number || h.estimate_number || '';

      // Show job action (create or match)
      var actionDiv = document.getElementById('pdf-job-action');
      if (pdfData.matched_job) {
        actionDiv.className = 'job-action-box match';
        actionDiv.innerHTML = '<div class="icon">‚úÖ</div><div class="text"><div class="title">Will update existing job: #' + pdfData.matched_job.job_number + ' - ' + pdfData.matched_job.job_name + '</div><div class="subtitle">Job already exists in system</div></div><span class="toggle-link" onclick="toggleJobOverride()">Change</span>';
        document.getElementById('summary-job').textContent = 'Update existing job: ' + pdfData.matched_job.job_name;
      } else if (jobName) {
        actionDiv.className = 'job-action-box create';
        actionDiv.innerHTML = '<div class="icon">‚ûï</div><div class="text"><div class="title">Will create new job: ' + escapeHtml(jobName) + '</div><div class="subtitle">Job # ' + (proposalNum ? 'P-' + proposalNum : 'Auto-generated') + '</div></div><span class="toggle-link" onclick="toggleJobOverride()">Change</span>';
        document.getElementById('summary-job').textContent = 'Create new job: ' + jobName;
      } else {
        actionDiv.className = 'job-action-box create';
        actionDiv.innerHTML = '<div class="icon">‚ö†Ô∏è</div><div class="text"><div class="title">No job name found in PDF</div><div class="subtitle">Please select an existing job below</div></div>';
        document.getElementById('job-override-section').style.display = 'block';
        document.getElementById('summary-job').textContent = 'Select a job manually';
      }

      // Populate job select for override
      var jobSelect = document.getElementById('pdf-job-select');
      jobSelect.innerHTML = '<option value="">-- Auto-create new job --</option>';
      pdfData.existing_jobs.forEach(function(j) {
        jobSelect.innerHTML += '<option value="' + j.id + '">#' + j.job_number + ' - ' + j.job_name + '</option>';
      });

      // Render header info
      var headerHtml = '';
      if (proposalNum) headerHtml += '<div class="header-item"><div class="label">Proposal #</div><div class="value highlight">' + proposalNum + '</div></div>';
      if (h.date) headerHtml += '<div class="header-item"><div class="label">Date</div><div class="value">' + h.date + '</div></div>';
      if (h.customer) headerHtml += '<div class="header-item"><div class="label">Customer</div><div class="value">' + h.customer + '</div></div>';
      if (h.job_name && h.job_name !== h.customer) headerHtml += '<div class="header-item"><div class="label">Job/Project</div><div class="value">' + h.job_name + '</div></div>';
      if (h.job_address) headerHtml += '<div class="header-item"><div class="label">Address</div><div class="value">' + h.job_address + '</div></div>';

      if (!headerHtml) headerHtml = '<div class="header-item"><div class="label">Note</div><div class="value">Limited header info extracted from PDF</div></div>';
      document.getElementById('pdf-header-info').innerHTML = headerHtml;

      // Render line items
      var tbody = document.querySelector('#pdf-line-items tbody');
      var items = pdfData.line_items || [];
      document.getElementById('pdf-item-count').textContent = items.length;
      document.getElementById('summary-count').textContent = items.length;

      if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#666;padding:30px;">No line items found in PDF</td></tr>';
        document.getElementById('pdf-total').textContent = '$0.00';
        document.getElementById('summary-income').textContent = 'No total found';
      } else {
        var total = h.total || 0;
        var html = '';
        items.forEach(function(item) {
          if (!total) total += item.total || 0;
          html += '<tr>' +
            '<td>' + escapeHtml(item.product || '-') + '</td>' +
            '<td>' + escapeHtml(item.description || '-') + '</td>' +
            '<td class="number">' + (item.qty || 0) + '</td>' +
            '<td class="number">$' + (item.rate || 0).toFixed(2) + '</td>' +
            '<td class="number">$' + (item.total || 0).toFixed(2) + '</td>' +
          '</tr>';
        });
        tbody.innerHTML = html;
        document.getElementById('pdf-total').textContent = '$' + (h.total || total).toLocaleString('en-US', {minimumFractionDigits: 2});
        document.getElementById('summary-income').textContent = 'Set job income to $' + (h.total || total).toLocaleString('en-US', {minimumFractionDigits: 2});
      }

      // Show step 2
      document.getElementById('pdf-step1').classList.add('hidden');
      document.getElementById('pdf-step2').classList.remove('hidden');
      document.getElementById('pdf-step3').classList.add('hidden');
      document.getElementById('pdf-import-result').innerHTML = '';
    }

    function toggleJobOverride() {
      var section = document.getElementById('job-override-section');
      section.style.display = section.style.display === 'none' ? 'block' : 'none';
    }

    async function executePdfImport() {
      var selectedJobId = document.getElementById('pdf-job-select').value;

      // Check if we have job info or selected job
      var h = pdfData.header;
      var jobName = h.job_name || h.customer || '';
      if (!jobName && !selectedJobId && !pdfData.matched_job) {
        alert('No job name found. Please select an existing job.');
        document.getElementById('job-override-section').style.display = 'block';
        return;
      }

      document.getElementById('pdf-import-btn').disabled = true;
      document.getElementById('pdf-import-btn').textContent = 'Importing...';

      try {
        var res = await fetch(API_BASE + '/qb-import/import-pdf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            header: pdfData.header,
            line_items: pdfData.line_items,
            selected_job_id: selectedJobId || (pdfData.matched_job ? pdfData.matched_job.id : null)
          })
        });

        var result = await res.json();

        if (result.error) {
          document.getElementById('pdf-import-result').innerHTML = '<div class="result-message error"><strong>Import Failed:</strong> ' + result.error + '</div>';
          document.getElementById('pdf-import-btn').disabled = false;
          document.getElementById('pdf-import-btn').textContent = 'Import Proposal';
          return;
        }

        // Success - show step 3
        importedJobId = result.job_id;
        var details = '';
        if (result.job_created) {
          details += '<p><strong>Created new job:</strong> #' + result.job_number + ' - ' + result.job_name + '</p>';
        } else if (result.job_matched) {
          details += '<p><strong>Updated existing job:</strong> #' + result.job_number + ' - ' + result.job_name + '</p>';
        }
        if (result.income_set > 0) {
          details += '<p><strong>Job income set to:</strong> $' + result.income_set.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</p>';
        }
        details += '<p><strong>Takeoffs imported:</strong> ' + result.imported + ' line items</p>';

        if (result.errors && result.errors.length > 0) {
          details += '<p style="color:#f97316;"><strong>Warnings:</strong> ' + result.errors.length + ' items had issues</p>';
        }

        document.getElementById('pdf-success-details').innerHTML = details;
        document.getElementById('pdf-step2').classList.add('hidden');
        document.getElementById('pdf-step3').classList.remove('hidden');

      } catch (e) {
        document.getElementById('pdf-import-result').innerHTML = '<div class="result-message error"><strong>Import Failed:</strong> ' + e.message + '</div>';
        document.getElementById('pdf-import-btn').disabled = false;
        document.getElementById('pdf-import-btn').textContent = 'Import Proposal';
      }
    }

    function goToJob() {
      if (importedJobId) {
        window.location.href = '/job-detail.html?id=' + importedJobId;
      }
    }

    function resetPdfImport() {
      pdfData = null;
      importedJobId = null;
      document.getElementById('pdf-file-input').value = '';
      document.getElementById('pdf-step1').classList.remove('hidden');
      document.getElementById('pdf-step2').classList.add('hidden');
      document.getElementById('pdf-step3').classList.add('hidden');
      document.getElementById('job-override-section').style.display = 'none';
      document.getElementById('pdf-import-btn').disabled = false;
      document.getElementById('pdf-import-btn').textContent = 'Import Proposal';
    }

    // ============ Paste Import Functions ============

    var pasteData = null;
    var pasteImportedJobId = null;
    var existingJobsList = [];

    // Load existing jobs for matching
    async function loadExistingJobs() {
      try {
        var res = await fetch(API_BASE + '/public/jobs');
        existingJobsList = await res.json();
      } catch (e) {
        console.error('Failed to load jobs:', e);
        existingJobsList = [];
      }
    }

    // Initialize
    loadExistingJobs();

    function parsePastedText() {
      var jobName = document.getElementById('paste-job-name').value.trim();
      var proposalNum = document.getElementById('paste-proposal-num').value.trim();
      var text = document.getElementById('paste-text').value.trim();

      if (!jobName) {
        alert('Please enter a Job Name');
        document.getElementById('paste-job-name').focus();
        return;
      }

      if (!text) {
        alert('Please paste the line items from QuickBooks');
        document.getElementById('paste-text').focus();
        return;
      }

      // Parse the pasted text
      var lineItems = parseLineItems(text);

      if (lineItems.length === 0) {
        alert('Could not parse any line items from the pasted text. Please check the format.');
        return;
      }

      // Calculate total
      var total = lineItems.reduce(function(sum, item) { return sum + (item.total || 0); }, 0);

      // Check for existing job match
      var matchedJob = null;
      for (var i = 0; i < existingJobsList.length; i++) {
        var j = existingJobsList[i];
        if (j.job_name.toLowerCase() === jobName.toLowerCase() ||
            j.job_name.toLowerCase().includes(jobName.toLowerCase()) ||
            jobName.toLowerCase().includes(j.job_name.toLowerCase())) {
          matchedJob = j;
          break;
        }
      }

      // Store parsed data
      pasteData = {
        header: {
          job_name: jobName,
          proposal_number: proposalNum,
          total: total
        },
        line_items: lineItems,
        matched_job: matchedJob
      };

      // Render the review screen
      renderPasteResults();
    }

    function parseLineItems(text) {
      var items = [];
      var lines = text.split('\n');

      for (var i = 0; i < lines.length; i++) {
        var line = lines[i].trim();
        if (!line) continue;

        // Skip header rows
        var lineLower = line.toLowerCase();
        if (lineLower.includes('product/service') ||
            lineLower.includes('description') && lineLower.includes('qty') ||
            lineLower.includes('activity') && lineLower.includes('rate') ||
            lineLower === 'product' || lineLower === 'service') {
          continue;
        }

        // Skip footer/total rows
        if (lineLower.startsWith('total') || lineLower.startsWith('subtotal') ||
            lineLower.includes('thank you') || lineLower.startsWith('notes:')) {
          continue;
        }

        var item = parseLineItem(line);
        if (item && item.product) {
          items.push(item);
        }
      }

      return items;
    }

    function parseLineItem(line) {
      var item = { product: '', description: '', qty: 0, rate: 0, total: 0 };

      // Try tab-separated first (common when copying from QB)
      var tabParts = line.split('\t');
      if (tabParts.length >= 3) {
        return parseFromParts(tabParts);
      }

      // Try to find numbers at the end of the line
      // Pattern: text followed by 2-3 numbers (qty, rate, total) or (qty, total) or just (total)

      // Pattern 1: Product   Description   Qty   Rate   Total
      var match3 = line.match(/^(.+?)\s+(\d+(?:\.\d+)?)\s+\$?([\d,]+(?:\.\d{2})?)\s+\$?([\d,]+(?:\.\d{2})?)\s*$/);
      if (match3) {
        var textPart = match3[1].trim();
        var textParts = textPart.split(/\s{2,}/);
        item.product = textParts[0] || textPart;
        item.description = textParts.slice(1).join(' ') || '';
        item.qty = parseFloat(match3[2]) || 0;
        item.rate = parseFloat(match3[3].replace(/,/g, '')) || 0;
        item.total = parseFloat(match3[4].replace(/,/g, '')) || 0;
        return item;
      }

      // Pattern 2: Text with two numbers at end (qty and total)
      var match2 = line.match(/^(.+?)\s+(\d+(?:\.\d+)?)\s+\$?([\d,]+(?:\.\d{2})?)\s*$/);
      if (match2) {
        var textPart2 = match2[1].trim();
        var textParts2 = textPart2.split(/\s{2,}/);
        item.product = textParts2[0] || textPart2;
        item.description = textParts2.slice(1).join(' ') || '';
        item.qty = parseFloat(match2[2]) || 1;
        item.total = parseFloat(match2[3].replace(/,/g, '')) || 0;
        item.rate = item.qty > 0 ? item.total / item.qty : item.total;
        return item;
      }

      // Pattern 3: Text with one number at end (just total)
      var match1 = line.match(/^(.+?)\s+\$?([\d,]+\.\d{2})\s*$/);
      if (match1) {
        var textPart3 = match1[1].trim();
        var textParts3 = textPart3.split(/\s{2,}/);
        item.product = textParts3[0] || textPart3;
        item.description = textParts3.slice(1).join(' ') || '';
        item.qty = 1;
        item.total = parseFloat(match1[2].replace(/,/g, '')) || 0;
        item.rate = item.total;
        return item;
      }

      // Pattern 4: Just text (might be a service item with no price yet)
      if (line.length > 3 && !line.match(/^\d/)) {
        item.product = line;
        item.qty = 1;
        return item;
      }

      return null;
    }

    function parseFromParts(parts) {
      var item = { product: '', description: '', qty: 0, rate: 0, total: 0 };

      // Clean up parts
      parts = parts.map(function(p) { return p.trim(); }).filter(function(p) { return p.length > 0; });

      if (parts.length >= 5) {
        // Full format: Product, Description, Qty, Rate, Total
        item.product = parts[0];
        item.description = parts[1];
        item.qty = parseFloat(parts[2]) || 1;
        item.rate = parseFloat(parts[3].replace(/[$,]/g, '')) || 0;
        item.total = parseFloat(parts[4].replace(/[$,]/g, '')) || 0;
      } else if (parts.length === 4) {
        // Could be: Product, Qty, Rate, Total OR Product, Description, Qty, Total
        var secondIsNumber = !isNaN(parseFloat(parts[1]));
        if (secondIsNumber) {
          item.product = parts[0];
          item.qty = parseFloat(parts[1]) || 1;
          item.rate = parseFloat(parts[2].replace(/[$,]/g, '')) || 0;
          item.total = parseFloat(parts[3].replace(/[$,]/g, '')) || 0;
        } else {
          item.product = parts[0];
          item.description = parts[1];
          item.qty = parseFloat(parts[2]) || 1;
          item.total = parseFloat(parts[3].replace(/[$,]/g, '')) || 0;
          item.rate = item.qty > 0 ? item.total / item.qty : item.total;
        }
      } else if (parts.length === 3) {
        // Product, Qty, Total
        item.product = parts[0];
        item.qty = parseFloat(parts[1]) || 1;
        item.total = parseFloat(parts[2].replace(/[$,]/g, '')) || 0;
        item.rate = item.qty > 0 ? item.total / item.qty : item.total;
      } else if (parts.length === 2) {
        // Product, Total
        item.product = parts[0];
        item.qty = 1;
        item.total = parseFloat(parts[1].replace(/[$,]/g, '')) || 0;
        item.rate = item.total;
      } else if (parts.length === 1) {
        item.product = parts[0];
        item.qty = 1;
      }

      return item;
    }

    function renderPasteResults() {
      var h = pasteData.header;
      var jobName = h.job_name;
      var proposalNum = h.proposal_number;

      // Show job action
      var actionDiv = document.getElementById('paste-job-action');
      if (pasteData.matched_job) {
        actionDiv.className = 'job-action-box match';
        actionDiv.innerHTML = '<div class="icon">‚úÖ</div><div class="text"><div class="title">Will update existing job: #' + pasteData.matched_job.job_number + ' - ' + pasteData.matched_job.job_name + '</div><div class="subtitle">Job already exists in system</div></div><span class="toggle-link" onclick="togglePasteJobOverride()">Change</span>';
        document.getElementById('paste-summary-job').textContent = 'Update existing job: ' + pasteData.matched_job.job_name;
      } else {
        actionDiv.className = 'job-action-box create';
        actionDiv.innerHTML = '<div class="icon">‚ûï</div><div class="text"><div class="title">Will create new job: ' + escapeHtml(jobName) + '</div><div class="subtitle">Job # ' + (proposalNum ? 'P-' + proposalNum : 'Auto-generated') + '</div></div><span class="toggle-link" onclick="togglePasteJobOverride()">Change</span>';
        document.getElementById('paste-summary-job').textContent = 'Create new job: ' + jobName;
      }

      // Populate job select for override
      var jobSelect = document.getElementById('paste-job-select');
      jobSelect.innerHTML = '<option value="">-- Auto-create new job --</option>';
      existingJobsList.forEach(function(j) {
        jobSelect.innerHTML += '<option value="' + j.id + '">#' + j.job_number + ' - ' + j.job_name + '</option>';
      });

      // Render header info
      var headerHtml = '';
      headerHtml += '<div class="header-item"><div class="label">Job Name</div><div class="value highlight">' + escapeHtml(jobName) + '</div></div>';
      if (proposalNum) headerHtml += '<div class="header-item"><div class="label">Proposal #</div><div class="value">' + escapeHtml(proposalNum) + '</div></div>';
      headerHtml += '<div class="header-item"><div class="label">Line Items</div><div class="value">' + pasteData.line_items.length + '</div></div>';
      document.getElementById('paste-header-info').innerHTML = headerHtml;

      // Render line items
      var tbody = document.querySelector('#paste-line-items tbody');
      var items = pasteData.line_items;
      document.getElementById('paste-item-count').textContent = items.length;
      document.getElementById('paste-summary-count').textContent = items.length;

      var html = '';
      items.forEach(function(item) {
        html += '<tr>' +
          '<td>' + escapeHtml(item.product || '-') + '</td>' +
          '<td>' + escapeHtml(item.description || '-') + '</td>' +
          '<td class="number">' + (item.qty || 0) + '</td>' +
          '<td class="number">$' + (item.rate || 0).toFixed(2) + '</td>' +
          '<td class="number">$' + (item.total || 0).toFixed(2) + '</td>' +
        '</tr>';
      });
      tbody.innerHTML = html;

      document.getElementById('paste-total').textContent = '$' + h.total.toLocaleString('en-US', {minimumFractionDigits: 2});
      document.getElementById('paste-summary-income').textContent = 'Set job income to $' + h.total.toLocaleString('en-US', {minimumFractionDigits: 2});

      // Show step 2
      document.getElementById('paste-step1').classList.add('hidden');
      document.getElementById('paste-step2').classList.remove('hidden');
      document.getElementById('paste-step3').classList.add('hidden');
      document.getElementById('paste-import-result').innerHTML = '';
    }

    function togglePasteJobOverride() {
      var section = document.getElementById('paste-job-override-section');
      section.style.display = section.style.display === 'none' ? 'block' : 'none';
    }

    async function executePasteImport() {
      var selectedJobId = document.getElementById('paste-job-select').value;

      document.getElementById('paste-import-btn').disabled = true;
      document.getElementById('paste-import-btn').textContent = 'Importing...';

      try {
        var res = await fetch(API_BASE + '/qb-import/import-pdf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            header: pasteData.header,
            line_items: pasteData.line_items,
            selected_job_id: selectedJobId || (pasteData.matched_job ? pasteData.matched_job.id : null)
          })
        });

        var result = await res.json();

        if (result.error) {
          document.getElementById('paste-import-result').innerHTML = '<div class="result-message error"><strong>Import Failed:</strong> ' + result.error + '</div>';
          document.getElementById('paste-import-btn').disabled = false;
          document.getElementById('paste-import-btn').textContent = 'Import Proposal';
          return;
        }

        // Success - show step 3
        pasteImportedJobId = result.job_id;
        var details = '';
        if (result.job_created) {
          details += '<p><strong>Created new job:</strong> #' + result.job_number + ' - ' + result.job_name + '</p>';
        } else if (result.job_matched) {
          details += '<p><strong>Updated existing job:</strong> #' + result.job_number + ' - ' + result.job_name + '</p>';
        }
        if (result.income_set > 0) {
          details += '<p><strong>Job income set to:</strong> $' + result.income_set.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</p>';
        }
        details += '<p><strong>Takeoffs imported:</strong> ' + result.imported + ' line items</p>';

        if (result.errors && result.errors.length > 0) {
          details += '<p style="color:#f97316;"><strong>Warnings:</strong> ' + result.errors.length + ' items had issues</p>';
        }

        document.getElementById('paste-success-details').innerHTML = details;
        document.getElementById('paste-step2').classList.add('hidden');
        document.getElementById('paste-step3').classList.remove('hidden');

        // Refresh jobs list
        loadExistingJobs();

      } catch (e) {
        document.getElementById('paste-import-result').innerHTML = '<div class="result-message error"><strong>Import Failed:</strong> ' + e.message + '</div>';
        document.getElementById('paste-import-btn').disabled = false;
        document.getElementById('paste-import-btn').textContent = 'Import Proposal';
      }
    }

    function goToPasteJob() {
      if (pasteImportedJobId) {
        window.location.href = '/job-costing.html';
      }
    }

    function resetPasteImport() {
      document.getElementById('paste-step1').classList.remove('hidden');
      document.getElementById('paste-step2').classList.add('hidden');
      document.getElementById('paste-step3').classList.add('hidden');
      document.getElementById('paste-job-override-section').style.display = 'none';
      document.getElementById('paste-import-btn').disabled = false;
      document.getElementById('paste-import-btn').textContent = 'Import Proposal';
      // Keep the text for editing if needed
    }
  </script>
</body>
</html>
