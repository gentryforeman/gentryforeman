<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reports - Commander Concrete</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f1f5f9; min-height: 100vh; }

/* Consistent Nav Bar */
.nav-header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: #1e293b;
  color: white;
  padding: 0 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 56px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.nav-header h1 {
  font-size: 18px;
  font-weight: 600;
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  white-space: nowrap;
}
.nav-btn {
  color: white;
  text-decoration: none;
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 14px;
  font-weight: 500;
  padding: 10px 14px;
  border-radius: 8px;
  transition: all 0.2s;
  min-height: 44px;
  background: none;
  border: none;
  cursor: pointer;
}
.nav-btn:hover { background: rgba(255,255,255,0.1); }
.nav-btn:active { background: rgba(255,255,255,0.2); }

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 24px 16px;
}

/* Report Tabs */
.report-tabs {
  display: flex;
  gap: 4px;
  background: white;
  padding: 4px;
  border-radius: 10px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  margin-bottom: 20px;
  overflow-x: auto;
}
.report-tab {
  flex: 1;
  min-width: 120px;
  padding: 12px 16px;
  border: none;
  background: transparent;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  color: #6b7280;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}
.report-tab:hover { background: #f3f4f6; }
.report-tab.active {
  background: #1e293b;
  color: white;
}

/* Filters */
.filters {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-bottom: 20px;
  padding: 16px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.filter-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.filter-group label {
  font-size: 11px;
  font-weight: 600;
  color: #6b7280;
  text-transform: uppercase;
}
.filter-group input, .filter-group select {
  padding: 10px 12px;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  font-size: 14px;
  min-width: 140px;
}
.filter-group input:focus, .filter-group select:focus {
  outline: none;
  border-color: #f97316;
}
.filter-actions {
  display: flex;
  align-items: flex-end;
  gap: 8px;
  margin-left: auto;
}
.btn {
  padding: 10px 16px;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-primary { background: #f97316; color: white; }
.btn-primary:hover { background: #ea580c; }
.btn-secondary { background: #e5e7eb; color: #374151; }
.btn-secondary:hover { background: #d1d5db; }
.btn-print { background: #1e293b; color: white; }
.btn-print:hover { background: #334155; }

/* Report Content */
.report-content {
  background: white;
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  overflow: hidden;
}
.report-header {
  padding: 16px 20px;
  background: #f8fafc;
  border-bottom: 1px solid #e5e7eb;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.report-title {
  font-size: 18px;
  font-weight: 600;
  color: #1f2937;
}
.report-subtitle {
  font-size: 13px;
  color: #6b7280;
  margin-top: 2px;
}

/* Table */
.report-table {
  width: 100%;
  border-collapse: collapse;
}
.report-table th {
  padding: 12px 16px;
  text-align: left;
  font-size: 11px;
  font-weight: 600;
  color: #6b7280;
  text-transform: uppercase;
  background: #f8fafc;
  border-bottom: 1px solid #e5e7eb;
  position: sticky;
  top: 0;
}
.report-table th.number { text-align: right; }
.report-table td {
  padding: 12px 16px;
  font-size: 14px;
  color: #374151;
  border-bottom: 1px solid #f3f4f6;
}
.report-table td.number {
  text-align: right;
  font-family: 'SF Mono', Monaco, monospace;
}
.report-table tr:hover { background: #fefce8; }
.report-table tr.total-row {
  background: #f8fafc;
  font-weight: 600;
}
.report-table tr.total-row td { border-top: 2px solid #e5e7eb; }

.positive { color: #16a34a; }
.negative { color: #dc2626; }

/* Mobile responsive table */
@media (max-width: 768px) {
  .report-table { font-size: 13px; }
  .report-table th, .report-table td { padding: 10px 12px; }
  .filters { flex-direction: column; }
  .filter-actions { margin-left: 0; width: 100%; }
  .filter-actions .btn { flex: 1; }
}

/* Empty state */
.empty-state {
  padding: 60px 24px;
  text-align: center;
  color: #9ca3af;
}
.empty-state-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }

/* Print styles */
@media print {
  body { background: white; }
  .header, .report-tabs, .filters, .filter-actions, .btn-print { display: none !important; }
  .container { padding: 0; max-width: none; }
  .report-content { box-shadow: none; }
  .report-table th { background: #f3f4f6 !important; -webkit-print-color-adjust: exact; }
  .report-table tr:hover { background: none; }
}

/* Loading */
.loading {
  padding: 40px;
  text-align: center;
  color: #9ca3af;
}
</style>
</head>
<body>

<nav class="nav-header">
  <button class="nav-btn" onclick="goBack()">‚Üê Back</button>
  <h1>Reports</h1>
  <a href="/home.html" class="nav-btn">Home</a>
</nav>

<script>
function goBack() {
  if (window.history.length > 1 && document.referrer) {
    window.history.back();
  } else {
    window.location.href = '/home.html';
  }
}
</script>

<div class="container">
  <!-- Report Tabs -->
  <div class="report-tabs">
    <button class="report-tab active" onclick="showReport('profitability')">Profitability</button>
    <button class="report-tab" onclick="showReport('payroll')">Payroll</button>
    <button class="report-tab" onclick="showReport('timesheet')">Worker Timesheet</button>
  </div>

  <!-- Profitability Report -->
  <div id="profitability-report" class="report-section">
    <div class="filters">
      <div class="filter-group">
        <label>From Date</label>
        <input type="date" id="profit-from">
      </div>
      <div class="filter-group">
        <label>To Date</label>
        <input type="date" id="profit-to">
      </div>
      <div class="filter-group">
        <label>Status</label>
        <select id="profit-status">
          <option value="all">All Jobs</option>
          <option value="active">Active Only</option>
          <option value="closed">Closed Only</option>
        </select>
      </div>
      <div class="filter-actions">
        <button class="btn btn-primary" onclick="loadProfitabilityReport()">Run Report</button>
        <button class="btn btn-print" onclick="window.print()">Print</button>
      </div>
    </div>
    <div class="report-content">
      <div class="report-header">
        <div>
          <div class="report-title">Job Profitability Report</div>
          <div class="report-subtitle" id="profit-date-range">All dates</div>
        </div>
      </div>
      <div id="profitability-table">
        <div class="loading">Loading report...</div>
      </div>
    </div>
  </div>

  <!-- Payroll Report -->
  <div id="payroll-report" class="report-section" style="display:none;">
    <div class="filters">
      <div class="filter-group">
        <label>From Date</label>
        <input type="date" id="payroll-from">
      </div>
      <div class="filter-group">
        <label>To Date</label>
        <input type="date" id="payroll-to">
      </div>
      <div class="filter-actions">
        <button class="btn btn-primary" onclick="loadPayrollReport()">Run Report</button>
        <button class="btn btn-print" onclick="window.print()">Print</button>
      </div>
    </div>
    <div class="report-content">
      <div class="report-header">
        <div>
          <div class="report-title">Payroll Summary Report</div>
          <div class="report-subtitle" id="payroll-date-range">All dates</div>
        </div>
      </div>
      <div id="payroll-table">
        <div class="loading">Loading report...</div>
      </div>
    </div>
  </div>

  <!-- Worker Timesheet -->
  <div id="timesheet-report" class="report-section" style="display:none;">
    <div class="filters">
      <div class="filter-group">
        <label>Worker</label>
        <select id="timesheet-worker">
          <option value="">Select Worker...</option>
        </select>
      </div>
      <div class="filter-group">
        <label>From Date</label>
        <input type="date" id="timesheet-from">
      </div>
      <div class="filter-group">
        <label>To Date</label>
        <input type="date" id="timesheet-to">
      </div>
      <div class="filter-actions">
        <button class="btn btn-primary" onclick="loadTimesheetReport()">Run Report</button>
        <button class="btn btn-print" onclick="window.print()">Print</button>
      </div>
    </div>
    <div class="report-content">
      <div class="report-header">
        <div>
          <div class="report-title">Worker Timesheet</div>
          <div class="report-subtitle" id="timesheet-date-range">Select a worker</div>
        </div>
      </div>
      <div id="timesheet-table">
        <div class="empty-state">
          <div class="empty-state-icon">üë∑</div>
          <p>Select a worker to view their timesheet</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
var API_BASE = '/api';
var currentReport = 'profitability';

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  // Set default date range (last 30 days)
  var today = new Date();
  var thirtyDaysAgo = new Date(today);
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

  var todayStr = today.toISOString().split('T')[0];
  var thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];

  document.getElementById('profit-from').value = thirtyDaysAgoStr;
  document.getElementById('profit-to').value = todayStr;
  document.getElementById('payroll-from').value = thirtyDaysAgoStr;
  document.getElementById('payroll-to').value = todayStr;
  document.getElementById('timesheet-from').value = thirtyDaysAgoStr;
  document.getElementById('timesheet-to').value = todayStr;

  loadWorkers();
  loadProfitabilityReport();
});

function showReport(reportType) {
  currentReport = reportType;

  // Update tabs
  document.querySelectorAll('.report-tab').forEach(function(tab) {
    tab.classList.remove('active');
  });
  event.target.classList.add('active');

  // Show/hide report sections
  document.querySelectorAll('.report-section').forEach(function(section) {
    section.style.display = 'none';
  });
  document.getElementById(reportType + '-report').style.display = 'block';

  // Load report if needed
  if (reportType === 'profitability') loadProfitabilityReport();
  else if (reportType === 'payroll') loadPayrollReport();
}

async function loadWorkers() {
  try {
    var res = await fetch(API_BASE + '/workers');
    var workers = await res.json();
    var opts = '<option value="">Select Worker...</option>';
    workers.filter(function(w) { return w.active !== false; }).forEach(function(w) {
      opts += '<option value="' + w.id + '">' + w.full_name + '</option>';
    });
    document.getElementById('timesheet-worker').innerHTML = opts;
  } catch(e) {
    console.error('Failed to load workers:', e);
  }
}

// ========== PROFITABILITY REPORT ==========
async function loadProfitabilityReport() {
  var from = document.getElementById('profit-from').value;
  var to = document.getElementById('profit-to').value;
  var status = document.getElementById('profit-status').value;

  var dateRange = '';
  if (from && to) dateRange = formatDate(from) + ' - ' + formatDate(to);
  else if (from) dateRange = 'From ' + formatDate(from);
  else if (to) dateRange = 'Through ' + formatDate(to);
  else dateRange = 'All dates';
  document.getElementById('profit-date-range').textContent = dateRange;

  var container = document.getElementById('profitability-table');
  container.innerHTML = '<div class="loading">Loading report...</div>';

  try {
    // Build query params
    var params = new URLSearchParams();
    if (from) params.append('from', from);
    if (to) params.append('to', to);

    var res = await fetch(API_BASE + '/job-costing-full?' + params.toString());
    var jobs = await res.json();

    // Filter by status
    if (status === 'active') {
      jobs = jobs.filter(function(j) { return j.status !== 'closed'; });
    } else if (status === 'closed') {
      jobs = jobs.filter(function(j) { return j.status === 'closed'; });
    }

    if (jobs.length === 0) {
      container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><p>No jobs found for this date range</p></div>';
      return;
    }

    var totals = { income: 0, materials: 0, labor: 0, other: 0, net: 0 };

    var html = '<table class="report-table">';
    html += '<thead><tr>';
    html += '<th>Job</th>';
    html += '<th class="number">Income</th>';
    html += '<th class="number">Materials</th>';
    html += '<th class="number">Labor</th>';
    html += '<th class="number">Other</th>';
    html += '<th class="number">Net Income</th>';
    html += '</tr></thead><tbody>';

    jobs.forEach(function(job) {
      var income = parseFloat(job.income) || 0;
      var materials = parseFloat(job.concrete_cost) || 0;
      var labor = parseFloat(job.labor_cost) || 0;
      var other = parseFloat(job.other_costs) || 0;
      var net = income - materials - labor - other;

      totals.income += income;
      totals.materials += materials;
      totals.labor += labor;
      totals.other += other;
      totals.net += net;

      html += '<tr>';
      html += '<td><strong>#' + (job.job_number || '') + '</strong> ' + (job.job_name || 'Unnamed') + '</td>';
      html += '<td class="number">' + formatCurrency(income) + '</td>';
      html += '<td class="number">' + formatCurrency(materials) + '</td>';
      html += '<td class="number">' + formatCurrency(labor) + '</td>';
      html += '<td class="number">' + formatCurrency(other) + '</td>';
      html += '<td class="number ' + (net >= 0 ? 'positive' : 'negative') + '">' + formatCurrency(net) + '</td>';
      html += '</tr>';
    });

    html += '<tr class="total-row">';
    html += '<td><strong>TOTALS (' + jobs.length + ' jobs)</strong></td>';
    html += '<td class="number">' + formatCurrency(totals.income) + '</td>';
    html += '<td class="number">' + formatCurrency(totals.materials) + '</td>';
    html += '<td class="number">' + formatCurrency(totals.labor) + '</td>';
    html += '<td class="number">' + formatCurrency(totals.other) + '</td>';
    html += '<td class="number ' + (totals.net >= 0 ? 'positive' : 'negative') + '">' + formatCurrency(totals.net) + '</td>';
    html += '</tr>';

    html += '</tbody></table>';
    container.innerHTML = html;

  } catch(e) {
    console.error('Error loading profitability report:', e);
    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><p>Failed to load report</p></div>';
  }
}

// ========== PAYROLL REPORT ==========
async function loadPayrollReport() {
  var from = document.getElementById('payroll-from').value;
  var to = document.getElementById('payroll-to').value;

  var dateRange = '';
  if (from && to) dateRange = formatDate(from) + ' - ' + formatDate(to);
  else if (from) dateRange = 'From ' + formatDate(from);
  else if (to) dateRange = 'Through ' + formatDate(to);
  else dateRange = 'All dates';
  document.getElementById('payroll-date-range').textContent = dateRange;

  var container = document.getElementById('payroll-table');
  container.innerHTML = '<div class="loading">Loading report...</div>';

  try {
    // Build query params
    var params = new URLSearchParams();
    if (from) params.append('from', from);
    if (to) params.append('to', to);

    var res = await fetch(API_BASE + '/reports/payroll?' + params.toString());
    var data = await res.json();

    if (!data.workers || data.workers.length === 0) {
      container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üë∑</div><p>No worker hours found for this date range</p></div>';
      return;
    }

    var totals = { regular: 0, ot: 0, total: 0, cost: 0 };

    var html = '<table class="report-table">';
    html += '<thead><tr>';
    html += '<th>Worker</th>';
    html += '<th class="number">Regular Hours</th>';
    html += '<th class="number">OT Hours</th>';
    html += '<th class="number">Total Hours</th>';
    html += '<th class="number">Labor Cost</th>';
    html += '</tr></thead><tbody>';

    data.workers.forEach(function(w) {
      var regular = parseFloat(w.regular_hours) || 0;
      var ot = parseFloat(w.ot_hours) || 0;
      var total = parseFloat(w.total_hours) || 0;
      var cost = parseFloat(w.total_cost) || 0;

      totals.regular += regular;
      totals.ot += ot;
      totals.total += total;
      totals.cost += cost;

      html += '<tr>';
      html += '<td>' + w.worker_name + '</td>';
      html += '<td class="number">' + regular.toFixed(1) + '</td>';
      html += '<td class="number">' + ot.toFixed(1) + '</td>';
      html += '<td class="number">' + total.toFixed(1) + '</td>';
      html += '<td class="number">' + formatCurrency(cost) + '</td>';
      html += '</tr>';
    });

    html += '<tr class="total-row">';
    html += '<td><strong>TOTALS (' + data.workers.length + ' workers)</strong></td>';
    html += '<td class="number">' + totals.regular.toFixed(1) + '</td>';
    html += '<td class="number">' + totals.ot.toFixed(1) + '</td>';
    html += '<td class="number">' + totals.total.toFixed(1) + '</td>';
    html += '<td class="number">' + formatCurrency(totals.cost) + '</td>';
    html += '</tr>';

    html += '</tbody></table>';
    container.innerHTML = html;

  } catch(e) {
    console.error('Error loading payroll report:', e);
    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><p>Failed to load report</p></div>';
  }
}

// ========== WORKER TIMESHEET ==========
async function loadTimesheetReport() {
  var workerId = document.getElementById('timesheet-worker').value;
  var from = document.getElementById('timesheet-from').value;
  var to = document.getElementById('timesheet-to').value;

  if (!workerId) {
    document.getElementById('timesheet-table').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üë∑</div><p>Select a worker to view their timesheet</p></div>';
    return;
  }

  var workerName = document.getElementById('timesheet-worker').options[document.getElementById('timesheet-worker').selectedIndex].text;
  var dateRange = workerName;
  if (from && to) dateRange += ' | ' + formatDate(from) + ' - ' + formatDate(to);
  document.getElementById('timesheet-date-range').textContent = dateRange;

  var container = document.getElementById('timesheet-table');
  container.innerHTML = '<div class="loading">Loading timesheet...</div>';

  try {
    var params = new URLSearchParams();
    params.append('worker_id', workerId);
    if (from) params.append('from', from);
    if (to) params.append('to', to);

    var res = await fetch(API_BASE + '/reports/timesheet?' + params.toString());
    var data = await res.json();

    if (!data.entries || data.entries.length === 0) {
      container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><p>No hours logged for this worker in the selected date range</p></div>';
      return;
    }

    var totalHours = 0;
    var totalCost = 0;

    var html = '<table class="report-table">';
    html += '<thead><tr>';
    html += '<th>Date</th>';
    html += '<th>Job</th>';
    html += '<th class="number">Hours</th>';
    html += '<th class="number">Rate</th>';
    html += '<th class="number">Amount</th>';
    html += '</tr></thead><tbody>';

    data.entries.forEach(function(e) {
      var hours = parseFloat(e.hours_worked) || 0;
      var rate = parseFloat(e.labor_rate) || 25;
      var amount = hours * rate;

      totalHours += hours;
      totalCost += amount;

      html += '<tr>';
      html += '<td>' + formatDate(e.record_date) + '</td>';
      html += '<td>#' + (e.job_number || '') + ' - ' + (e.job_name || 'Unknown') + '</td>';
      html += '<td class="number">' + hours.toFixed(1) + '</td>';
      html += '<td class="number">' + formatCurrency(rate) + '/hr</td>';
      html += '<td class="number">' + formatCurrency(amount) + '</td>';
      html += '</tr>';
    });

    html += '<tr class="total-row">';
    html += '<td colspan="2"><strong>TOTAL (' + data.entries.length + ' entries)</strong></td>';
    html += '<td class="number">' + totalHours.toFixed(1) + '</td>';
    html += '<td class="number"></td>';
    html += '<td class="number">' + formatCurrency(totalCost) + '</td>';
    html += '</tr>';

    html += '</tbody></table>';
    container.innerHTML = html;

  } catch(e) {
    console.error('Error loading timesheet:', e);
    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><p>Failed to load timesheet</p></div>';
  }
}

// ========== HELPERS ==========
function formatCurrency(amount) {
  if (amount === null || amount === undefined) return '$0.00';
  return '$' + parseFloat(amount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  var d = new Date(dateStr + 'T12:00:00');
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}
</script>

</body>
</html>
